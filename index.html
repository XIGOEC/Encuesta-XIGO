<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <style>
        :root { --xigo: #2D5A27; }
        .text-xigo { color: var(--xigo); }
        .bg-xigo { background-color: var(--xigo); }
        .border-xigo { border-color: var(--xigo); }
        .option-selected { border-color: var(--xigo); background-color: #f0fdf4; color: var(--xigo); transform: scale(1.01); }
        body { background-color: #f8fafc; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        .app-container { max-width: 450px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.05); position: relative; }
        .brand-header { background-color: #f8fafc; height: 100px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-bottom: 4px solid var(--xigo); cursor: pointer; user-select: none; }
        .brand-logo-img { width: 100%; height: 100%; object-fit: contain; padding: 15px; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <header class="brand-header" id="admin-trigger">
        <!-- Logo de XIGO -->
        <img src="https://lh3.googleusercontent.com/u/0/d/1WmKpnJPnBgB3OyYqe-a-OgRODLuuPjTq=w1000" alt="XIGO" class="brand-logo-img" onerror="this.src='https://placehold.co/400x150/2D5A27/FFFFFF?text=XIGO'">
    </header>

    <div class="px-8 pt-6" id="progress-container">
        <div class="flex justify-between items-end mb-2">
            <span id="section-name" class="text-[10px] font-black text-xigo uppercase tracking-[0.2em] italic">Cargando...</span>
            <span id="questions-count" class="text-[10px] font-bold text-gray-300 uppercase">Pregunta 1</span>
        </div>
        <div class="w-full bg-gray-100 h-1 rounded-full overflow-hidden">
            <div id="prog-bar" class="bg-xigo h-full w-0 transition-all duration-500"></div>
        </div>
    </div>

    <main id="survey-ui" class="flex-1 px-8 py-6 overflow-y-auto custom-scroll">
        <div class="flex flex-col items-center justify-center h-64 text-center">
            <div class="w-8 h-8 border-4 border-xigo border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-gray-400 font-bold uppercase text-[9px] tracking-widest text-center">Iniciando sistema...</p>
        </div>
    </main>

    <footer id="footer-ui" class="px-8 pb-8 hidden">
        <button id="next-btn" onclick="next()" class="w-full bg-xigo text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all">
            Continuar
        </button>
    </footer>
</div>

<script>
    // --- CONFIGURACI√ìN DE PREGUNTAS (PDF COMPLETO) ---
    const questions = [
        { s: 'Filtro', id: 'F1', q: '¬øEn los √∫ltimos 30 d√≠as, has comprado comida preparada o empacada para consumir fuera de casa?', opt: ['S√≠, lo he comprado', 'No, pero lo considerar√≠a si fuera conveniente', 'No, no me interesa'], type: 'single', exit: 'No, no me interesa' },
        { s: 'Perfil', id: 'F2', q: '¬øCu√°l describe mejor tu situaci√≥n actual?', opt: ['Trabajo fuera de casa', 'Trabajo desde casa/online', 'Trabajo mixto', 'Estudiante / No trabajo'], type: 'single' },
        { s: 'Frecuencia', id: 'F3', q: '¬øCon qu√© frecuencia almuerzas fuera de casa en una semana?', opt: ['0 veces', '1-2 veces', '3-4 veces', '5+ veces'], type: 'single' },
        { s: 'Comida', id: 'C1', q: '¬øHas comprado comida preparada para consumir despu√©s (refrigerada o tarrinas)?', opt: ['S√≠, regularmente', 'S√≠, algunas veces', 'No, pero me llama la atenci√≥n', 'No, no me interesa'], type: 'single' },
        { s: 'Momentos', id: 'C2', q: '¬øEn qu√© situaciones considerar√≠as consumir comida lista?', opt: ['Poco tiempo para almorzar', 'Reuniones continuas', 'No alcanc√© a cocinar', 'Comer en la oficina', 'Entre traslados', 'Para llevar a casa'], type: 'multi', max: 6 },
        { s: 'Potencial', id: 'C3', q: '¬øQu√© tipo de comida te genera m√°s confianza empacada?', opt: ['Tradicional ecuatoriana', 'Casera ligera', 'Bowls balanceados', 'Ensaladas completas', 'Sopas y cremas', 'Snacks salados'], type: 'multi', max: 3 },
        { s: 'Valor', id: 'C5', q: '¬øQu√© esperas de un almuerzo para sentir que "vali√≥ la pena"?', opt: ['Que me llene', 'Que sea saludable', 'Mucha prote√≠na', 'R√°pido y pr√°ctico', 'Buen sabor'], type: 'multi', max: 3 },
        { s: 'Barreras', id: 'C6', q: '¬øQu√© factor te har√≠a dudar al comprar comida lista?', opt: ['Frescura', 'Higiene', 'Sabor', 'Precio', 'Conservantes', 'Empaque', 'Caducidad'], type: 'multi', max: 3 },
        { s: 'Gasto', id: 'P1', q: '¬øEn promedio, cu√°nto sueles pagar hoy por tu almuerzo?', opt: ['Menos de $4.99', '$5.99 - $7.99', '$8.00 - $9.99', '$10.00 - $11.99', '$12.00 o m√°s'], type: 'single' },
        { s: 'Precio Ideal', id: 'P2', q: '¬øQu√© precio te parece razonable por un producto XIGO (Fresco y Premium)?', opt: ['Hasta $5.99', '$6.00 - $7.99', '$8.00 - $9.99', '$10.00 o m√°s'], type: 'single' },
        { s: 'Escenario', id: 'P3', q: 'Si un almuerzo de $5.99 subiera a $7.99 por mejora en ingredientes, ¬øqu√© har√≠as?', opt: ['Lo sigo comprando', 'Compro con menos frecuencia', 'Busco otra opci√≥n', 'Dejo de comprarlo'], type: 'single' },
        { s: 'Bebidas', id: 'R1', q: 'Durante tu jornada laboral, ¬øcompras bebidas listas para tomar?', opt: ['Diario', 'Varias veces/semana', 'Ocasionalmente', 'Rara vez', 'Nunca'], type: 'single' },
        { s: 'Potencial RTD', id: 'R2', q: '¬øQu√© bebida lista te resultar√≠a m√°s atractiva?', opt: ['Agua saborizada', 'Jugo natural fresco', 'T√© fr√≠o artesanal', 'Caf√© latte / Matcha', 'Bebida funcional'], type: 'multi', max: 2 },
        { s: 'Leches', id: 'R4', q: '¬øQu√© tipo de leche prefieres en tus bebidas?', opt: ['Entera', 'Deslactosada', 'Almendra', 'Avena', 'No consumo leche'], type: 'multi', max: 2 },
        { s: 'Demograf√≠a', id: 'E1', q: '¬øCu√°l es tu rango de edad?', opt: ['18-24', '25-34', '35-44', '45-54', '55+'], type: 'single' },
        { s: 'Zona', id: 'U1', q: '¬øEn qu√© zona realizas tus actividades?', opt: ['Norte', 'Centro', 'Sur', 'Samborond√≥n', 'Dur√°n'], type: 'single' }
    ];

    let current = 0, results = {}, selections = [], db = null, auth = null, clicks = 0;
    let isDemoMode = true; // Por defecto modo local para GitHub Pages
    const appId = "xigo-survey-v2";

    async function init() {
        try {
            // Si el usuario configura estas variables en GitHub Secrets o similar, Firebase se activa
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const firebaseConfig = JSON.parse(__firebase_config);
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                isDemoMode = false;
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            }
        } catch (e) {
            console.warn("Modo Local Activado");
        }
        render();
    }

    function render() {
        if (current >= questions.length) return final();
        const item = questions[current], ui = document.getElementById('survey-ui'), footer = document.getElementById('footer-ui');
        document.getElementById('prog-bar').style.width = Math.round((current / questions.length) * 100) + '%';
        document.getElementById('questions-count').innerText = `Pregunta ${current + 1} de ${questions.length}`;
        document.getElementById('section-name').innerText = item.s;
        selections = [];
        footer.classList.toggle('hidden', item.type === 'single');
        
        ui.innerHTML = `
            <div class="fade-in">
                <h2 class="text-2xl font-black text-gray-800 leading-tight mb-8">${item.q}</h2>
                <div class="space-y-3 pb-8">
                    ${item.opt.map(o => `
                        <button onclick="pick('${o.replace(/'/g, "\\'")}')" class="opt-btn w-full text-left p-5 border-2 border-gray-50 rounded-2xl font-bold text-gray-500 transition-all flex justify-between items-center group">
                            <span class="pr-4">${o}</span>
                            <div class="indicator min-w-[10px] h-[10px] rounded-full bg-gray-100"></div>
                        </button>
                    `).join('')}
                </div>
                ${item.type === 'multi' ? `<p class="text-[9px] text-gray-300 font-bold uppercase tracking-widest text-center mt-4 italic">Elige hasta ${item.max}</p>` : ''}
            </div>`;
        ui.scrollTop = 0;
    }

    window.pick = (val) => {
        const item = questions[current];
        if (item.type === 'single') {
            if (item.exit && val === item.exit) return finishExit();
            results[item.id] = val;
            current++; render();
        } else {
            if (selections.includes(val)) {
                selections = selections.filter(s => s !== val);
            } else if (selections.length < item.max) {
                selections.push(val);
            }
            updateVisuals();
            results[item.id] = selections;
        }
    };

    function updateVisuals() {
        document.querySelectorAll('.opt-btn').forEach(b => {
            const t = b.querySelector('span').innerText.trim();
            const ind = b.querySelector('.indicator');
            if (selections.includes(t)) {
                b.classList.add('option-selected');
                ind.classList.replace('bg-gray-100', 'bg-xigo');
            } else {
                b.classList.remove('option-selected');
                ind.classList.replace('bg-xigo', 'bg-gray-100');
            }
        });
    }

    window.next = () => { if (selections.length > 0) { current++; render(); } };

    function final() {
        document.getElementById('footer-ui').classList.add('hidden');
        document.getElementById('survey-ui').innerHTML = `
            <div class="text-center py-4 fade-in">
                <div class="text-5xl mb-6">ü•ó</div>
                <h2 class="text-3xl font-black text-gray-800 mb-2 uppercase italic">¬°CASI LISTO!</h2>
                <p class="text-gray-400 font-medium mb-8 text-sm px-4 italic leading-relaxed">Ingresa tu correo para recibir un 15% de descuento en Vina Mar√≠a.</p>
                <input type="email" id="email" placeholder="tu@email.com" class="w-full p-5 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-xigo outline-none text-center font-bold text-lg mb-4 shadow-inner">
                <button onclick="save()" id="save-btn" class="w-full bg-xigo text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">Obtener mi cup√≥n</button>
                <p class="text-[8px] text-gray-300 mt-6 uppercase font-bold tracking-widest">XIGO ¬© 2026</p>
            </div>`;
    }

    async function save() {
        const emailInput = document.getElementById('email');
        const email = emailInput.value.trim();
        if (!email.includes('@')) return alert("Por favor ingresa un email v√°lido");
        
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "PROCESANDO...";
        
        const data = { 
            email, 
            responses: results, 
            timestamp: new Date().toISOString()
        };

        // Guardar localmente siempre (como respaldo)
        let localData = JSON.parse(localStorage.getItem('xigo_responses') || '[]');
        localData.push(data);
        localStorage.setItem('xigo_responses', JSON.stringify(localData));

        if (!isDemoMode && db) {
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add(data);
            } catch (e) { 
                console.error("Error al subir a nube, guardado localmente.");
            }
        }
        
        setTimeout(showCoupon, 800);
    }

    function showCoupon() {
        document.getElementById('survey-ui').innerHTML = `
            <div class="text-center py-8 fade-in">
                <div class="w-16 h-16 bg-green-50 text-xigo rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <p class="text-gray-400 font-bold text-[10px] uppercase mb-1">Tu c√≥digo es:</p>
                <h2 class="text-xigo text-5xl font-black italic mb-8 tracking-tighter">XIGO15</h2>
                <div class="p-6 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200 text-xs text-gray-500 font-medium italic">
                    Toma una captura o presenta este c√≥digo en @vinamariaec para validar tu beneficio.
                </div>
                <button onclick="location.reload()" class="mt-12 text-gray-300 font-bold uppercase text-[9px] tracking-[0.3em]">Cerrar</button>
            </div>`;
    }

    function finishExit() {
        document.getElementById('survey-ui').innerHTML = `<div class="text-center py-20 fade-in"><p class="text-gray-400 font-bold uppercase tracking-widest text-xs">Gracias por tu tiempo.</p><button onclick="location.reload()" class="mt-10 text-xigo font-black uppercase text-[10px] underline">Volver al inicio</button></div>`;
    }

    // --- PANEL ADMINISTRADOR PARA GITHUB ---
    document.getElementById('admin-trigger').onclick = () => { 
        clicks++;
        if (clicks >= 5) { 
            clicks = 0;
            const pass = prompt("Clave Administrador XIGO:");
            if (pass === "XIGO2026") showAdmin(); 
        } 
    };

    async function showAdmin() {
        const ui = document.getElementById('survey-ui');
        ui.innerHTML = `<div class="text-center py-10"><p class="animate-pulse text-[10px] font-bold text-gray-400 uppercase">Accediendo a registros...</p></div>`;
        
        let docs = JSON.parse(localStorage.getItem('xigo_responses') || '[]');
        
        if (!isDemoMode && db) {
            try {
                const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').get();
                let cloudDocs = [];
                snap.forEach(doc => cloudDocs.push(doc.data()));
                if (cloudDocs.length > 0) docs = cloudDocs;
            } catch (e) { console.warn("Usando datos locales."); }
        }

        window.latestData = docs;

        ui.innerHTML = `
            <div class="fade-in space-y-4">
                <div class="bg-black text-white p-6 rounded-3xl flex justify-between items-center shadow-2xl">
                    <div><p class="text-[8px] font-bold text-xigo uppercase">Total Registros</p><p class="text-4xl font-black italic">${docs.length}</p></div>
                    <button onclick="exportCSV()" class="bg-xigo px-5 py-3 rounded-2xl text-[10px] font-black uppercase shadow-lg">Descargar Excel</button>
                </div>
                <div class="max-h-64 overflow-y-auto pr-2 space-y-2 custom-scroll">
                    ${docs.length === 0 ? '<p class="text-center text-gray-300 text-[10px] py-10 uppercase font-bold">Sin datos a√∫n</p>' : 
                    docs.reverse().map(d => `
                        <div class="p-4 bg-gray-50 rounded-2xl flex justify-between items-center text-[10px] border border-gray-100">
                            <span class="font-bold truncate w-2/3 text-gray-700">${d.email}</span>
                            <span class="text-gray-300 font-bold">${new Date(d.timestamp).toLocaleDateString()}</span>
                        </div>
                    `).join('')}
                </div>
                <button onclick="location.reload()" class="w-full py-4 text-gray-400 font-bold text-[9px] uppercase tracking-widest">Salir del panel</button>
            </div>`;
    }

    window.exportCSV = () => {
        if (!window.latestData || window.latestData.length === 0) return alert("No hay datos para exportar");
        
        const headers = ["Email", "Fecha", ...questions.map(q => q.id)];
        const rows = window.latestData.map(d => [
            d.email, 
            d.timestamp, 
            ...questions.map(q => {
                let val = d.responses[q.id] || "";
                return Array.isArray(val) ? val.join(" | ") : val;
            })
        ].map(cell => `"${cell}"`).join(","));
        
        const blob = new Blob(["\uFEFF" + headers.join(",") + "\n" + rows.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `XIGO_DATA_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    };

    window.onload = init;
</script>
</body>
</html>
