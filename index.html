<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase App (v10) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .header-bg { background-color: #2D5A27; height: 160px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .header-img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .option-btn.selected { border-color: #2D5A27; background-color: #f0fdf4; color: #2D5A27; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide { display: none; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen sm:p-4">

    <div id="app-container" class="bg-white w-full h-full sm:max-w-md sm:h-[800px] sm:rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col border border-gray-100">
        <!-- Header -->
        <div class="header-bg flex-shrink-0" id="admin-trigger">
            <img src="https://i.ibb.co/SD87TqHW/Black-Modern-Minimalist-Letter-A-Logo-1-1.png" class="header-img" alt="XIGO">
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" class="px-8 pt-6">
            <div class="w-full bg-gray-100 h-1.5 rounded-full">
                <div id="progress-bar" class="bg-[#2D5A27] h-full rounded-full transition-all duration-500" style="width: 5%"></div>
            </div>
        </div>

        <!-- Content -->
        <div id="main-content" class="flex-1 p-8 flex flex-col overflow-y-auto">
            <!-- Las preguntas se inyectan aquí -->
        </div>

        <!-- Footer Action (Para multi-selección) -->
        <div id="footer-action" class="p-8 hide">
            <button id="next-btn" class="w-full bg-[#2D5A27] text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
                Siguiente
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN Y DATOS ---
        const ADMIN_PASSWORD = "XIGO2026";
        const surveyData = [
            { section: "Filtro", title: "¿En los últimos 30 días, has comprado comida preparada o empacada para consumir fuera de casa?", options: ["Sí, lo he comprado", "No, pero lo consideraría", "No, no me interesa"], type: "single", terminate: "No, no me interesa" },
            { section: "Filtro", title: "¿Cuál describe mejor tu situación actual?", options: ["Trabajo fuera de casa", "Trabajo desde casa / Online", "Trabajo mixto", "Estudiante / No trabajo"], type: "single" },
            { section: "Comida", title: "¿En qué situaciones elegirías comida lista durante un día laboral?", options: ["Poco tiempo", "Reuniones continuas", "No alcancé a cocinar", "Para comer en oficina", "Traslados", "Para llevar a casa"], type: "multiple" },
            { section: "Comida", title: "¿Qué tipo de comida te genera más confianza empacada? (Máx 3)", options: ["Tradicional ecuatoriana", "Casera ligera", "Bowls balanceados", "Ensaladas completas", "Sopas / Cremas", "Snacks salados"], type: "multiple", max: 3 },
            { section: "Precios", title: "¿Cuánto sueles pagar por tu almuerzo promedio entre semana?", options: ["Menos de $4.99", "$5.00 a $7.99", "$8.00 a $9.99", "$10.00 a $11.99", "$12.00 o más"], type: "single" },
            { section: "Bebidas", title: "¿Compras bebidas listas para tomar (agua, jugos, tés) en el trabajo?", options: ["Diario", "Varias veces/semana", "Ocasionalmente", "Rara vez", "Nunca"], type: "single" },
            { section: "Perfil", title: "¿En qué rango de edad te encuentras?", options: ["18-24", "25-34", "35-44", "45-54", "55+"], type: "single" }
        ];

        let currentIdx = 0;
        let answers = {};
        let selectedInStep = [];
        let adminClicks = 0;

        // --- FIREBASE SETUP ---
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-universal';

        // Auth Silenciosa
        auth.signInAnonymously().catch(e => console.error("Auth error", e));

        // --- FUNCIONES CORE ---
        const mainContent = document.getElementById('main-content');
        const progressBar = document.getElementById('progress-bar');
        const footerAction = document.getElementById('footer-action');
        const nextBtn = document.getElementById('next-btn');

        function renderStep() {
            if (currentIdx >= surveyData.length) {
                renderEmailStep();
                return;
            }

            const q = surveyData[currentIdx];
            selectedInStep = [];
            footerAction.classList.add('hide');
            
            // Actualizar progreso
            progressBar.style.width = `${((currentIdx + 1) / surveyData.length) * 100}%`;

            let html = `
                <div class="fade-in">
                    <p class="text-[#2D5A27] font-black text-[10px] uppercase tracking-widest mb-1 opacity-60">${q.section}</p>
                    <h2 class="text-xl font-black text-gray-800 leading-tight mb-6">${q.title}</h2>
                    <div class="space-y-3" id="options-container">
                        ${q.options.map(o => `
                            <button onclick="handleOptionClick('${o.replace(/'/g, "\\'")}')" class="option-btn w-full p-4 rounded-2xl text-left text-sm font-bold border-2 border-gray-100 text-gray-600 transition-all active:scale-[0.98]">
                                ${o}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            mainContent.innerHTML = html;
        }

        window.handleOptionClick = (val) => {
            const q = surveyData[currentIdx];
            
            if (q.type === 'single') {
                if (q.terminate && val === q.terminate) {
                    renderTerminated();
                    return;
                }
                
                // Efecto visual de selección
                const btns = document.querySelectorAll('.option-btn');
                btns.forEach(b => {
                    if (b.innerText.trim() === val) b.classList.add('selected');
                    else b.classList.remove('selected');
                });

                answers[q.title] = val;
                setTimeout(() => {
                    currentIdx++;
                    renderStep();
                }, 300);
            } else {
                // Lógica de selección múltiple
                const btn = Array.from(document.querySelectorAll('.option-btn')).find(b => b.innerText.trim() === val);
                
                if (selectedInStep.includes(val)) {
                    selectedInStep = selectedInStep.filter(i => i !== val);
                    btn.classList.remove('selected');
                } else {
                    if (q.max && selectedInStep.length >= q.max) return;
                    selectedInStep.push(val);
                    btn.classList.add('selected');
                }
                
                answers[q.title] = selectedInStep;
                
                if (selectedInStep.length > 0) footerAction.classList.remove('hide');
                else footerAction.classList.add('hide');
            }
        };

        nextBtn.onclick = () => {
            currentIdx++;
            renderStep();
        };

        function renderEmailStep() {
            progressBar.style.width = '100%';
            footerAction.classList.add('hide');
            mainContent.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center text-center fade-in">
                    <h2 class="text-2xl font-black mb-2 tracking-tighter text-gray-800 uppercase">¡Casi terminamos!</h2>
                    <p class="text-sm text-gray-500 mb-8 px-4 font-medium italic">Déjanos tu correo para recibir tu cupón y finalizar.</p>
                    <input type="email" id="email-input" placeholder="tu@email.com" class="w-full p-4 border-2 rounded-2xl mb-4 text-center font-bold outline-none focus:border-[#2D5A27] transition-colors" />
                    <button onclick="submitFinal()" id="submit-btn" class="bg-[#2D5A27] text-white py-4 rounded-2xl font-black uppercase tracking-widest w-full shadow-xl">
                        FINALIZAR
                    </button>
                </div>
            `;
        }

        window.submitFinal = async () => {
            const email = document.getElementById('email-input').value;
            if (!email.includes('@')) {
                alert("Email no válido");
                return;
            }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerText = "ENVIANDO...";

            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add({
                    email: email,
                    responses: answers,
                    date: new Date().toLocaleString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                renderSuccess();
            } catch (e) {
                alert("Error: " + e.message);
                btn.disabled = false;
                btn.innerText = "FINALIZAR";
            }
        };

        function renderSuccess() {
            document.getElementById('progress-container').classList.add('hide');
            mainContent.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center text-center fade-in p-6">
                    <div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mb-6 border-4 border-[#2D5A27] text-[#2D5A27] text-3xl font-bold">✓</div>
                    <h2 class="text-2xl font-black text-[#2D5A27] mb-2">¡GRACIAS!</h2>
                    <p class="text-gray-500 text-sm font-medium">Tus respuestas se guardaron. Pronto recibirás noticias nuestras.</p>
                    <button onclick="location.reload()" class="mt-10 text-[10px] font-black text-gray-400 uppercase tracking-widest underline">Nueva encuesta</button>
                </div>
            `;
        }

        function renderTerminated() {
            mainContent.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center text-center fade-in opacity-60">
                    <h2 class="text-xl font-black mb-4 uppercase">Gracias por tu tiempo</h2>
                    <p class="text-sm px-6">Esta encuesta está dirigida a compradores frecuentes de comida lista.</p>
                    <button onclick="location.reload()" class="mt-6 text-[#2D5A27] font-bold text-xs underline">REINTENTAR</button>
                </div>
            `;
        }

        // --- MODO ADMIN ---
        document.getElementById('admin-trigger').onclick = () => {
            adminClicks++;
            if (adminClicks >= 5) {
                const p = prompt("Password:");
                if (p === ADMIN_PASSWORD) renderAdmin();
                adminClicks = 0;
            }
        };

        async function renderAdmin() {
            mainContent.innerHTML = `<p class="text-center p-10 font-bold text-gray-400">Cargando base de datos...</p>`;
            document.getElementById('progress-container').classList.add('hide');
            
            try {
                const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').get();
                let html = `<div class="fade-in"><h2 class="font-black text-xl mb-4 text-[#2D5A27]">REGISTROS (${snap.size})</h2>`;
                
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                        <div class="bg-gray-50 p-4 rounded-xl mb-3 border border-gray-100">
                            <p class="text-xs font-black text-[#2D5A27] mb-1">${d.email}</p>
                            <p class="text-[9px] text-gray-400 mb-2">${d.date}</p>
                            <div class="text-[10px] space-y-1">
                                ${Object.entries(d.responses || {}).map(([q, a]) => `
                                    <div class="flex flex-col border-b border-gray-200 pb-1 mb-1">
                                        <span class="font-bold text-gray-500">${q}</span>
                                        <span class="text-gray-800">${Array.isArray(a) ? a.join(', ') : a}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                html += `<button onclick="location.reload()" class="w-full mt-4 p-4 text-xs font-black text-gray-400 uppercase tracking-widest border rounded-xl">Cerrar</button></div>`;
                mainContent.innerHTML = html;
            } catch (e) {
                alert("Error admin: " + e.message);
            }
        }

        // Inicio
        renderStep();
    </script>
</body>
</html>
