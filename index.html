<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <style>
        :root { --xigo: #2D5A27; }
        .text-xigo { color: var(--xigo); }
        .bg-xigo { background-color: var(--xigo); }
        .border-xigo { border-color: var(--xigo); }
        .option-selected { border-color: var(--xigo); background-color: #f0fdf4; color: var(--xigo); transform: scale(1.01); }
        body { background-color: #f8fafc; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .app-container { max-width: 450px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.05); }
        .brand-header { background-color: #000; height: 120px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-bottom: 4px solid var(--xigo); cursor: pointer; }
        .brand-logo-img { width: 100%; height: 100%; object-fit: cover; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <header class="brand-header" id="admin-trigger">
        <img src="https://lh3.googleusercontent.com/u/0/d/1WmKpnJPnBgB3OyYqe-a-OgRODLuuPjTq=w1000" alt="XIGO" class="brand-logo-img">
    </header>

    <div class="px-8 pt-6" id="progress-container">
        <div class="flex justify-between items-end mb-2">
            <span id="section-name" class="text-[10px] font-black text-xigo uppercase tracking-[0.2em] italic">Cargando...</span>
            <span id="questions-count" class="text-[10px] font-bold text-gray-300 uppercase">Pregunta 1</span>
        </div>
        <div class="w-full bg-gray-100 h-1 rounded-full overflow-hidden">
            <div id="prog-bar" class="bg-xigo h-full w-0 transition-all duration-500"></div>
        </div>
    </div>

    <main id="survey-ui" class="flex-1 px-8 py-6 overflow-y-auto custom-scroll">
        <div class="flex flex-col items-center justify-center h-64 text-center">
            <div class="w-8 h-8 border-4 border-xigo border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-gray-400 font-bold uppercase text-[9px] tracking-widest text-center">Iniciando XIGO Cloud Database...</p>
        </div>
    </main>

    <footer id="footer-ui" class="px-8 pb-8 hidden">
        <button id="next-btn" onclick="next()" class="w-full bg-xigo text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all">
            Continuar
        </button>
    </footer>
</div>

<script>
    const questions = [
        { s: 'Filtro', id: 'F1', q: 'Â¿En los Ãºltimos 30 dÃ­as, has comprado comida preparada o empacada para consumir fuera de casa?', opt: ['SÃ­, lo he comprado', 'No, pero lo considerarÃ­a si fuera conveniente', 'No, no me interesa'], type: 'single', exit: 'No, no me interesa' },
        { s: 'Perfil', id: 'F2', q: 'Â¿CuÃ¡l describe mejor tu situaciÃ³n actual?', opt: ['Trabajo fuera de casa (Oficina)', 'Trabajo desde casa / online', 'Trabajo mixto', 'Estudiante / No trabajo'], type: 'single' },
        { s: 'Perfil', id: 'F3', q: 'Â¿Con quÃ© frecuencia almuerzas fuera de casa en una semana?', opt: ['0 veces', '1-2 veces', '3-4 veces', '5+ veces'], type: 'single' },
        { s: 'AceptaciÃ³n', id: 'C1', q: 'Â¿QuÃ© tan atractiva te parece la idea de un lugar de comida "Grab & Go" (comida lista y fresca)?', opt: ['Muy atractiva', 'Algo atractiva', 'Neutral', 'Poco atractiva', 'Nada atractiva'], type: 'single' },
        { s: 'Comida', id: 'C2', q: 'Â¿Has comprado comida preparada para consumir despuÃ©s (tarrinas)?', opt: ['SÃ­, regularmente', 'SÃ­, algunas veces', 'No, pero me llama la atenciÃ³n', 'No, no me interesa'], type: 'single' },
        { s: 'Momentos', id: 'C3', q: 'Â¿En quÃ© situaciones considerarÃ­as consumir comida lista?', opt: ['Poco tiempo para almorzar', 'Reuniones continuas', 'No alcancÃ© a cocinar', 'Comer en la oficina', 'Entre traslados', 'Para llevar a casa'], type: 'multi', max: 6 },
        { s: 'Preferencias', id: 'C4', q: 'Â¿QuÃ© tipo de comida te genera mÃ¡s confianza empacada?', opt: ['Tradicional ecuatoriana', 'Casera ligera', 'Bowls balanceados', 'Ensaladas completas', 'Sopas y cremas', 'Snacks salados'], type: 'multi', max: 3 },
        { s: 'PorciÃ³n', id: 'C5', q: 'Â¿QuÃ© tamaÃ±o de porciÃ³n prefieres normalmente?', opt: ['Ligero', 'Normal', 'Grande', 'Depende del dÃ­a'], type: 'single' },
        { s: 'Valor', id: 'C6', q: 'Â¿QuÃ© esperas de un almuerzo para sentir que "valiÃ³ la pena"?', opt: ['Que me llene', 'Que sea saludable', 'Mucha proteÃ­na', 'RÃ¡pido y prÃ¡ctico', 'Buen sabor'], type: 'multi', max: 3 },
        { s: 'Barreras', id: 'C7', q: 'Â¿QuÃ© factor te harÃ­a dudar al comprar comida lista?', opt: ['Frescura', 'Higiene', 'Sabor', 'Precio', 'Conservantes', 'Empaque', 'Caducidad'], type: 'multi', max: 3 },
        { s: 'HÃ¡bito', id: 'C8', q: 'Â¿Con quÃ© frecuencia la consumirÃ­as si estuviera cerca?', opt: ['Nunca', '1 vez por semana', '2-3 veces por semana', 'Casi todos los dÃ­as'], type: 'single' },
        { s: 'Delivery', id: 'D1', q: 'Â¿PedirÃ­as comida lista por delivery?', opt: ['SÃ­, con frecuencia', 'SÃ­, ocasionalmente', 'Tal vez', 'No'], type: 'single' },
        { s: 'Formato', id: 'D2', q: 'Â¿QuÃ© formato de delivery prefieres?', opt: ['Almuerzo del dÃ­a', 'Pack 2-3 dÃ­as', 'Pack semanal', 'Depende'], type: 'single' },
        { s: 'Precio', id: 'P1', q: 'Â¿CuÃ¡nto pagas hoy por almuerzo?', opt: ['Menos de $4.99', '$5.99 - $7.99', '$8.00 - $9.99', '$10.00 - $11.99', '$12.00 o mÃ¡s'], type: 'single' },
        { s: 'Ideal', id: 'P2', q: 'Â¿Precio razonable por almuerzo fresco y listo?', opt: ['Menos de $4.99', '$5.99 - $7.99', '$8.00 - $9.99', '$10.00 - $11.99', '$12.00 o mÃ¡s'], type: 'single' },
        { s: 'Elasticidad', id: 'P3', q: 'Si sube de $5.99 a $7.99, Â¿quÃ© haces?', opt: ['Sigo comprando', 'Compro menos', 'Busco otra opciÃ³n', 'Dejo de comprar'], type: 'single' },
        { s: 'Bebidas', id: 'R1', q: 'Â¿Compras bebidas listas en jornada laboral?', opt: ['Diario', 'Varias veces/semana', 'Ocasionalmente', 'Rara vez', 'Nunca'], type: 'single' },
        { s: 'Bebidas', id: 'R2', q: 'Â¿QuÃ© bebida te resultarÃ­a mÃ¡s atractiva?', opt: ['Agua saborizada', 'Jugo natural', 'TÃ© frÃ­o', 'CafÃ© latte/Matcha', 'Funcional', 'Refrescante', 'No compro'], type: 'multi', max: 2 },
        { s: 'Leches', id: 'R3', q: 'Â¿QuÃ© tipo de leche prefieres?', opt: ['Entera', 'Deslactosada', 'Almendra', 'Avena', 'Soya', 'No consumo leche'], type: 'multi', max: 2 },
        { s: 'Precio Bebida', id: 'R4', q: 'Â¿Precio razonable para bebida RTD?', opt: ['Hasta $1.99', '$2.49 - $2.99', '$3.49 - $3.99', '$4.49 - $4.99', '$5.00 o mÃ¡s'], type: 'single' },
        { s: 'DemografÃ­a', id: 'E1', q: 'Â¿CuÃ¡l es tu gÃ©nero?', opt: ['Femenino', 'Masculino', 'Otro'], type: 'single' },
        { s: 'DemografÃ­a', id: 'E2', q: 'Â¿CuÃ¡l es tu rango de edad?', opt: ['18-24', '25-34', '35-44', '45-54', '55+'], type: 'single' },
        { s: 'UbicaciÃ³n', id: 'U1', q: 'Â¿En quÃ© zona de Guayaquil actividades?', opt: ['Norte', 'Centro', 'Sur', 'SamborondÃ³n', 'DurÃ¡n'], type: 'single' }
    ];

    let current = 0, results = {}, selections = [], db = null, auth = null, clicks = 0;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-app';

    async function init() {
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            
            // AutenticaciÃ³n requerida antes de cualquier operaciÃ³n
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }
            render();
        } catch (e) {
            console.error(e);
            document.getElementById('survey-ui').innerHTML = `<p class="text-center text-red-500 font-bold">Error de inicializaciÃ³n. Recarga la pÃ¡gina.</p>`;
        }
    }

    function render() {
        if (current >= questions.length) return final();
        const item = questions[current], ui = document.getElementById('survey-ui'), footer = document.getElementById('footer-ui');
        document.getElementById('prog-bar').style.width = Math.round((current / questions.length) * 100) + '%';
        document.getElementById('questions-count').innerText = `Pregunta ${current + 1} de ${questions.length}`;
        document.getElementById('section-name').innerText = item.s;
        selections = [];
        footer.classList.toggle('hidden', item.type === 'single');
        ui.innerHTML = `<div class="fade-in"><h2 class="text-2xl font-black text-gray-800 leading-tight mb-8">${item.q}</h2><div class="space-y-3 pb-8">${item.opt.map(o => `<button onclick="pick('${o.replace(/'/g, "\\'")}')" class="opt-btn w-full text-left p-5 border-2 border-gray-50 rounded-2xl font-bold text-gray-500 transition-all flex justify-between items-center group"><span class="pr-4">${o}</span><div class="indicator min-w-[10px] h-[10px] rounded-full bg-gray-100"></div></button>`).join('')}</div>${item.type === 'multi' ? `<p class="text-[9px] text-gray-300 font-bold uppercase tracking-widest text-center mt-4 italic">Elige hasta ${item.max}</p>` : ''}</div>`;
        ui.scrollTop = 0;
    }

    window.pick = (val) => {
        const item = questions[current];
        if (item.type === 'single') {
            if (item.exit && val === item.exit) return finishExit();
            results[item.id] = val;
            current++; render();
        } else {
            if (selections.includes(val)) {
                selections = selections.filter(s => s !== val);
            } else if (selections.length < item.max) {
                selections.push(val);
            }
            updateVisuals();
            results[item.id] = selections;
        }
    };

    function updateVisuals() {
        document.querySelectorAll('.opt-btn').forEach(b => {
            const t = b.querySelector('span').innerText.trim(), ind = b.querySelector('.indicator');
            if (selections.includes(t)) {
                b.classList.add('option-selected');
                ind.classList.replace('bg-gray-100', 'bg-xigo');
            } else {
                b.classList.remove('option-selected');
                ind.classList.replace('bg-xigo', 'bg-gray-100');
            }
        });
    }

    window.next = () => { if (selections.length > 0) { current++; render(); } };

    function final() {
        document.getElementById('footer-ui').classList.add('hidden');
        document.getElementById('survey-ui').innerHTML = `<div class="text-center py-4 fade-in"><div class="text-5xl mb-6">ðŸ¥—</div><h2 class="text-3xl font-black text-gray-800 mb-2 uppercase italic">Â¡CASI LISTO!</h2><p class="text-gray-400 font-medium mb-8 text-sm px-4 italic">Ingresa tu correo para guardar tus respuestas y obtener tu cupÃ³n del 15%.</p><input type="email" id="email" placeholder="tu@email.com" class="w-full p-5 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-xigo outline-none text-center font-bold text-lg mb-4"><button onclick="save()" id="save-btn" class="w-full bg-xigo text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95">Guardar y Finalizar</button></div>`;
    }

    async function save() {
        const email = document.getElementById('email').value.trim();
        if (!email.includes('@')) return;
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "GUARDANDO...";
        
        const data = { 
            email, 
            responses: results, 
            timestamp: new Date().toISOString(), 
            uid: auth.currentUser?.uid 
        };

        try {
            // RUTA OBLIGATORIA: /artifacts/{appId}/public/data/{collection}
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add(data);
            showCoupon();
        } catch (e) { 
            console.error(e);
            alert("Error de conexiÃ³n con la base de datos."); 
            btn.disabled = false; 
            btn.innerText = "Reintentar"; 
        }
    }

    function showCoupon() {
        document.getElementById('survey-ui').innerHTML = `<div class="text-center py-8 fade-in"><div class="w-16 h-16 bg-green-50 text-xigo rounded-full flex items-center justify-center mx-auto mb-6"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><p class="text-gray-400 font-bold text-[10px] uppercase mb-1">Tu cÃ³digo es:</p><h2 class="text-xigo text-5xl font-black italic mb-8 tracking-tighter">XIGO15</h2><div class="p-6 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200 text-xs text-gray-500 font-medium italic">Presenta este cÃ³digo en @vinamariaec</div><button onclick="location.reload()" class="mt-12 text-gray-300 font-bold uppercase text-[9px] tracking-[0.3em]">Cerrar</button></div>`;
    }

    function finishExit() {
        document.getElementById('survey-ui').innerHTML = `<div class="text-center py-20 fade-in"><p class="text-gray-400 font-bold uppercase tracking-widest text-xs">Gracias por tu tiempo.</p><button onclick="location.reload()" class="mt-10 text-xigo font-black uppercase text-[10px] underline">Volver</button></div>`;
    }

    // PANEL ADMINISTRATIVO
    document.getElementById('admin-trigger').onclick = () => { 
        clicks++;
        if (clicks >= 5) { 
            clicks = 0;
            const pass = prompt("Clave de Administrador:");
            if (pass === "XIGO2026") showAdmin(); 
        } 
    };

    async function showAdmin() {
        const ui = document.getElementById('survey-ui');
        ui.innerHTML = `<div class="flex flex-col items-center justify-center h-64"><div class="w-6 h-6 border-2 border-xigo border-t-transparent rounded-full animate-spin mb-4"></div><p class="text-[9px] font-bold uppercase tracking-widest text-gray-400">Consultando Base de Datos...</p></div>`;
        
        try {
            if (!auth.currentUser) await auth.signInAnonymously();
            
            // Usamos la ruta corregida
            const colRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses');
            const snap = await colRef.get();
            
            const docs = [];
            snap.forEach(doc => docs.push(doc.data()));
            
            if (docs.length === 0) {
                ui.innerHTML = `<div class="text-center py-20"><p class="text-gray-300 font-bold uppercase text-[10px]">No hay respuestas aÃºn</p><button onclick="location.reload()" class="mt-4 text-xigo font-bold text-[10px] underline">Volver</button></div>`;
                return;
            }

            window.latestData = docs;

            ui.innerHTML = `
                <div class="space-y-4 fade-in">
                    <div class="p-6 bg-black text-white rounded-3xl flex justify-between items-center">
                        <div><p class="text-[8px] uppercase font-bold text-xigo italic">Total Respuestas</p><p class="text-4xl font-black italic tracking-tighter">${docs.length}</p></div>
                        <button onclick="exportCSV()" class="bg-xigo px-4 py-3 rounded-xl text-[9px] font-black uppercase tracking-widest hover:scale-105 transition-transform">Descargar CSV</button>
                    </div>
                    <div class="max-h-[350px] overflow-y-auto custom-scroll pr-2 space-y-2">
                        ${docs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(d => `
                            <div class="p-4 bg-gray-50 rounded-2xl flex justify-between items-center">
                                <div class="overflow-hidden">
                                    <p class="text-[10px] font-black text-gray-700 truncate">${d.email}</p>
                                    <p class="text-[8px] font-bold text-gray-300 uppercase">${new Date(d.timestamp).toLocaleString()}</p>
                                </div>
                                <div class="text-[8px] font-black text-xigo bg-white px-2 py-1 rounded-md shadow-sm">OK</div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="location.reload()" class="w-full py-4 text-gray-300 font-bold text-[9px] uppercase tracking-widest">Cerrar SesiÃ³n</button>
                </div>
            `;
        } catch (e) { 
            console.error(e);
            ui.innerHTML = `<div class="p-10 text-center"><p class="text-red-500 font-bold text-xs">Error: No se pudo acceder a los datos.</p><p class="text-[9px] text-gray-400 mt-2">AsegÃºrate de haber guardado al menos una respuesta primero.</p><button onclick="location.reload()" class="mt-6 text-xigo font-bold text-[10px] underline">Reintentar</button></div>`; 
        }
    }

    window.exportCSV = () => {
        if (!window.latestData) return;
        const headers = ["Email", "Fecha", ...questions.map(q => q.q.replace(/,/g, ""))];
        const rows = window.latestData.map(d => {
            const row = [d.email, d.timestamp];
            questions.forEach(q => {
                let val = d.responses[q.id] || "";
                if (Array.isArray(val)) val = val.join(" | ");
                row.push(val.toString().replace(/,/g, ";")); // Reemplazamos comas internas para no romper el CSV
            });
            return row.join(",");
        });
        
        const csvContent = "\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `XIGO_REPORT_${new Date().getTime()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    window.onload = init;
</script>
</body>
</html>
