<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs - Compat Mode para m√°xima estabilidad -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <style>
        :root { --xigo: #2D5A27; }
        .text-xigo { color: var(--xigo); }
        .bg-xigo { background-color: var(--xigo); }
        .border-xigo { border-color: var(--xigo); }
        .option-selected { border-color: var(--xigo); background-color: #f0fdf4; color: var(--xigo); transform: scale(1.02); }
        
        body { 
            background-color: #f1f5f9; 
            margin: 0;
            padding: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .app-container { 
            max-width: 450px; 
            margin: 0 auto; 
            min-height: 100vh; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        
        .brand-header {
            background-color: #000000;
            padding: 0;
            border-bottom: 4px solid var(--xigo);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 120px;
            overflow: hidden;
        }

        .brand-logo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        /* Animaciones suaves */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app-container shadow-2xl">
    <!-- Header -->
    <header class="brand-header cursor-pointer" id="admin-trigger" title="Clic 5 veces para Admin">
        <img src="https://lh3.googleusercontent.com/u/0/d/1WmKpnJPnBgB3OyYqe-a-OgRODLuuPjTq=w1000" alt="XIGO Logo" class="brand-logo-img" onerror="this.src='https://via.placeholder.com/450x120?text=XIGO+PREMIUM'">
    </header>

    <!-- Progreso -->
    <div class="px-8 pt-6" id="progress-container">
        <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
            <div id="prog-bar" class="bg-xigo h-full w-0 transition-all duration-500"></div>
        </div>
        <div class="flex justify-between mt-2">
            <span id="section-name" class="text-[9px] font-black text-xigo uppercase tracking-widest italic">Cargando...</span>
            <span id="questions-left" class="text-[9px] font-bold text-gray-400 uppercase">Calculando...</span>
        </div>
    </div>

    <!-- UI Principal -->
    <main id="survey-ui" class="flex-1 px-8 py-8 overflow-y-auto custom-scrollbar">
        <div class="flex flex-col items-center justify-center h-full text-center">
            <div class="w-8 h-8 border-4 border-xigo border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-gray-400 font-bold uppercase text-[10px] tracking-widest">Iniciando sistema XIGO...</p>
        </div>
    </main>

    <!-- Footer para Selecci√≥n M√∫ltiple -->
    <footer id="footer-ui" class="px-8 pb-8 hidden">
        <button id="next-btn" onclick="next()" class="w-full bg-xigo text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">
            Continuar
        </button>
    </footer>
</div>

<script>
    // --- CONFIGURACI√ìN Y ESTADO ---
    let db = null;
    let auth = null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : "xigo-survey-2026";
    const ADMIN_PASS = "XIGO2026";
    
    // Datos de la encuesta basados en el PDF
    const questions = [
        { s: 'Filtro', id: 'F1', q: '¬øEn los √∫ltimos 30 d√≠as, has comprado comida preparada o empacada para consumir fuera de casa?', opt: ['S√≠, lo he comprado', 'No, pero lo considerar√≠a', 'No, no me interesa'], type: 'single', exit: 'No, no me interesa' },
        { s: 'Filtro', id: 'F2', q: '¬øCu√°l describe mejor tu situaci√≥n actual?', opt: ['Trabajo fuera de casa', 'Trabajo desde casa/online', 'Trabajo mixto', 'Estudiante/ No trabajo'], type: 'single' },
        { s: 'Filtro', id: 'F3', q: '¬øCon qu√© frecuencia almuerzas fuera de casa en una semana?', opt: ['0 veces', '1-2 veces', '3-4 veces', '5+ veces'], type: 'single' },
        { s: 'Comida', id: 'C1', q: '¬øHas comprado alguna vez comida preparada para consumir despu√©s?', opt: ['S√≠, regularmente', 'S√≠, algunas veces', 'No, pero me llama la atenci√≥n', 'No, no me interesa'], type: 'single' },
        { s: 'Comida', id: 'C2', q: '¬øEn qu√© situaciones considerar√≠as consumir comida lista?', opt: ['Poco tiempo para almorzar', 'Reuniones de trabajo', 'No alcanc√© a cocinar', 'Para comer en la oficina', 'Para llevar a casa'], type: 'multi', max: 5 },
        { s: 'Comida', id: 'C3', q: '¬øQu√© tipo de comida te genera m√°s confianza empacada?', opt: ['Tradicional ecuatoriana', 'Casera ligera (Arroz, prote√≠na)', 'Bowls balanceados', 'Ensaladas completas', 'Sopas/cremas'], type: 'multi', max: 3 },
        { s: 'Comida', id: 'C4', q: '¬øQu√© tama√±o de porci√≥n prefieres normalmente?', opt: ['Ligero', 'Normal', 'Grande', 'Depende del d√≠a'], type: 'single' },
        { s: 'Comida', id: 'C5', q: '¬øQu√© esperas para sentir que "vali√≥ la pena"?', opt: ['Que me llene', 'Que sea saludable', 'Mucha prote√≠na', 'R√°pido y pr√°ctico', 'Buen sabor'], type: 'multi', max: 3 },
        { s: 'Comida', id: 'C6', q: '¬øQu√© factor te har√≠a dudar?', opt: ['Frescura', 'Higiene', 'Sabor', 'Precio', 'Conservantes', 'Empaque sostenible'], type: 'multi', max: 3 },
        { s: 'Delivery', id: 'D1', q: '¬øPedir√≠as comida lista por delivery si fuera fresca?', opt: ['S√≠, con frecuencia', 'S√≠, ocasionalmente', 'Tal vez', 'No'], type: 'single' },
        { s: 'Precio', id: 'P1', q: '¬øCu√°nto sueles pagar hoy por tu almuerzo?', opt: ['Menos de $4.99', '$5.99-$7.99', '$7.99-$9.99', '$9.99-$11.99', '$11.99 o m√°s'], type: 'single' },
        { s: 'Precio', id: 'P2', q: '¬øPrecio razonable para excelente calidad?', opt: ['Menos de $4.99', '$5.99-$7.99', '$7.99-$9.99', '$9.99-$11.99', '$11.99 o m√°s'], type: 'single' },
        { s: 'Bebidas', id: 'R1', q: '¬øCompras bebidas listas para tomar (RTD)?', opt: ['Casi siempre', 'Varias veces/semana', 'Ocasionalmente', 'Rara vez', 'Nunca'], type: 'single' },
        { s: 'Bebidas', id: 'R2', q: '¬øQu√© opci√≥n te resulta m√°s atractiva?', opt: ['Agua saborizada', 'Jugo natural fresco', 'T√© fr√≠o natural', 'Caf√© latte / Matcha', 'Bebida funcional'], type: 'multi', max: 2 },
        { s: 'Perfil', id: 'D1', q: '¬øCu√°l es tu rango de edad?', opt: ['18-24', '25-34', '35-44', '45-54', '55+'], type: 'single' },
        { s: 'Perfil', id: 'D2', q: '¬øEn qu√© zona realizas tus actividades?', opt: ['Norte', 'Centro', 'Sur', 'Samborond√≥n / V. Costa', 'Dur√°n'], type: 'single' }
    ];

    let current = 0;
    let results = {};
    let selections = [];
    let clickCount = 0;

    // --- L√ìGICA DE INICIALIZACI√ìN ---
    async function init() {
        try {
            if (typeof __firebase_config !== 'undefined') {
                const config = JSON.parse(__firebase_config);
                if (!firebase.apps.length) firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Auth An√≥nimo para guardar datos
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            }
            render(); // Iniciar encuesta una vez conectado
        } catch (e) {
            console.error("Error Firebase:", e);
            // Si falla, permitimos que la encuesta siga y guardamos en LocalStorage como backup
            render();
        }
    }

    function render() {
        if (current >= questions.length) return final();
        const item = questions[current];
        const ui = document.getElementById('survey-ui');
        const footer = document.getElementById('footer-ui');
        
        // Actualizar progreso
        const perc = Math.round((current / questions.length) * 100);
        document.getElementById('prog-bar').style.width = perc + '%';
        document.getElementById('questions-left').innerText = `Pregunta ${current + 1} de ${questions.length}`;
        document.getElementById('section-name').innerText = item.s;

        selections = [];
        footer.classList.toggle('hidden', item.type === 'single');

        ui.innerHTML = `
            <div class="fade-in">
                <h2 class="text-2xl font-black text-gray-800 leading-tight mb-8">${item.q}</h2>
                <div class="space-y-3 pb-10">
                    ${item.opt.map(o => `
                        <button onclick="pick('${o.replace(/'/g, "\\'")}')" class="opt-btn w-full text-left p-5 border-2 border-gray-100 rounded-2xl font-bold text-gray-500 transition-all active:scale-[0.98] flex justify-between items-center">
                            <span>${o}</span>
                            <div class="indicator w-2 h-2 rounded-full bg-gray-200"></div>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    window.pick = (val) => {
        const item = questions[current];
        const btns = document.querySelectorAll('.opt-btn');

        if (item.type === 'single') {
            if (item.exit && val === item.exit) return finishExit();
            results[item.id] = val;
            current++;
            render();
        } else {
            if (selections.includes(val)) {
                selections = selections.filter(s => s !== val);
            } else if (selections.length < item.max) {
                selections.push(val);
            }
            
            // Actualizar UI de botones
            btns.forEach(b => {
                const text = b.querySelector('span').innerText.trim();
                const ind = b.querySelector('.indicator');
                if (selections.includes(text)) {
                    b.classList.add('option-selected');
                    ind.classList.replace('bg-gray-200', 'bg-xigo');
                } else {
                    b.classList.remove('option-selected');
                    ind.classList.replace('bg-xigo', 'bg-gray-200');
                }
            });
            results[item.id] = selections;
        }
    };

    window.next = () => {
        if (selections.length > 0) {
            current++;
            render();
        }
    };

    function final() {
        document.getElementById('footer-ui').classList.add('hidden');
        document.getElementById('progress-container').classList.add('opacity-20');
        document.getElementById('survey-ui').innerHTML = `
            <div class="text-center py-4 fade-in">
                <div class="text-6xl mb-6">üéÅ</div>
                <h2 class="text-3xl font-black text-gray-800 mb-4 uppercase italic tracking-tighter">¬°GRACIAS!</h2>
                <p class="text-gray-400 font-medium mb-8 px-4">Ingresa tu correo para recibir tu cup√≥n del <b>15% de descuento</b> en Vina Mar√≠a.</p>
                <input type="email" id="email" placeholder="tu@email.com" class="w-full p-5 bg-gray-50 rounded-2xl border-2 border-transparent focus:border-xigo outline-none text-center font-bold text-lg mb-4">
                <button onclick="save()" id="save-btn" class="w-full bg-xigo text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">Obtener Cup√≥n</button>
            </div>
        `;
    }

    async function save() {
        const email = document.getElementById('email').value;
        if (!email.includes('@')) return alert("Ingresa un correo v√°lido");
        
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.innerText = "GUARDANDO...";
        
        const data = { email, results, ts: new Date().toISOString() };

        try {
            if (db) {
                // Guardar en la ruta requerida por el sistema
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add(data);
            } else {
                // Si no hay DB, guardamos localmente como emergencia
                const logs = JSON.parse(localStorage.getItem('xigo_backup') || '[]');
                logs.push(data);
                localStorage.setItem('xigo_backup', JSON.stringify(logs));
            }
            showCoupon();
        } catch (e) {
            console.error(e);
            alert("Error al conectar. Tu respuesta se guard√≥ localmente.");
            showCoupon();
        }
    }

    function showCoupon() {
        document.getElementById('survey-ui').innerHTML = `
            <div class="text-center py-10 fade-in">
                <div class="w-20 h-20 bg-green-100 text-xigo rounded-full flex items-center justify-center mx-auto mb-6 text-3xl">‚úì</div>
                <h2 class="text-xigo text-5xl font-black italic mb-2">XIGO15</h2>
                <p class="font-bold text-gray-800 mb-6 uppercase tracking-widest text-[10px]">Tu c√≥digo de descuento</p>
                <div class="p-6 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200 text-sm text-gray-500 font-medium leading-relaxed italic">
                    "Muestra esta pantalla en @vinamariaec para redimir tu beneficio."
                </div>
                <button onclick="location.reload()" class="mt-12 text-gray-300 font-bold uppercase text-[9px] tracking-[0.4em]">Finalizar</button>
            </div>
        `;
    }

    function finishExit() {
        document.getElementById('survey-ui').innerHTML = `
            <div class="text-center py-20 px-6 fade-in">
                <p class="text-gray-400 font-bold uppercase tracking-widest text-sm leading-loose">Gracias por tu tiempo. Por ahora buscamos perfiles que consuman comida empacada con frecuencia.</p>
                <button onclick="location.reload()" class="mt-10 text-xigo font-black uppercase text-[10px] tracking-widest">Volver</button>
            </div>
        `;
    }

    // --- PANEL ADMIN ---
    document.getElementById('admin-trigger').onclick = () => {
        clickCount++;
        if (clickCount >= 5) {
            const p = prompt("Acceso Administrativo XIGO:");
            if (p === ADMIN_PASS) showAdmin();
            clickCount = 0;
        }
    };

    async function showAdmin() {
        const ui = document.getElementById('survey-ui');
        ui.innerHTML = `<div class="p-10 text-center font-bold text-gray-400 animate-pulse">CARGANDO M√âTRICAS...</div>`;
        
        try {
            if (!db) throw new Error("Sin conexi√≥n a DB");
            const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').get();
            
            ui.innerHTML = `
                <div class="space-y-4 fade-in">
                    <div class="p-8 bg-black text-white rounded-3xl border-b-4 border-xigo">
                        <p class="text-[10px] uppercase font-bold text-xigo tracking-widest mb-1">Total Respuestas</p>
                        <p class="text-6xl font-black italic tracking-tighter">${snap.size}</p>
                    </div>
                    <div class="p-6 bg-gray-50 rounded-3xl max-h-80 overflow-y-auto custom-scrollbar">
                        <p class="text-[10px] font-black text-gray-400 uppercase mb-4">Correos Recientes:</p>
                        ${snap.docs.reverse().slice(0, 15).map(doc => `
                            <div class="py-2 border-b border-gray-200 text-xs font-bold text-gray-600 flex justify-between">
                                <span>${doc.data().email}</span>
                                <span class="opacity-30 text-[9px]">${new Date(doc.data().ts).toLocaleDateString()}</span>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="location.reload()" class="w-full py-4 text-gray-400 font-bold text-[10px] uppercase tracking-widest">Salir</button>
                </div>
            `;
        } catch (e) {
            ui.innerHTML = `
                <div class="p-8 text-center">
                    <p class="text-red-500 font-bold mb-4">Error: ${e.message}</p>
                    <p class="text-xs text-gray-400 mb-6">Aseg√∫rate de que el sitio est√© configurado correctamente en Firebase.</p>
                    <button onclick="location.reload()" class="bg-gray-100 px-6 py-2 rounded-xl font-bold text-[10px]">REINTENTAR</button>
                </div>
            `;
        }
    }

    // Iniciar
    init();
</script>
</body>
</html>
