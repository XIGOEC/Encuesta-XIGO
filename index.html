<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta Oficial</title>
    <style>
        :root { --primary: #2D5A27; --bg: #f8fafc; --text: #1e293b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; background: var(--bg); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        #app { 
            background: white; width: 100%; max-width: 500px; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        @media (min-height: 600px) and (min-width: 500px) {
            #app { height: 850px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); }
        }
        
        .header { 
            background: #000; height: 180px; width: 100%; display: flex; 
            align-items: center; justify-content: center; flex-shrink: 0;
            overflow: hidden; border-bottom: 4px solid var(--primary); padding: 0;
            cursor: pointer;
        }
        .header img { width: 100%; height: 100%; object-fit: cover; display: block; }

        .progress-container { padding: 15px 25px 5px; background: white; }
        .progress-bar { background: #f1f5f9; height: 6px; border-radius: 10px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: width 0.4s ease; }
        .content { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }
        .section-tag { font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; }
        .question-title { font-size: 1.15rem; font-weight: 800; color: var(--text); line-height: 1.3; margin-bottom: 20px; }
        .option-btn { 
            width: 100%; padding: 14px 18px; margin-bottom: 10px; border: 2px solid #f1f5f9;
            border-radius: 14px; text-align: left; font-weight: 600; color: #64748b;
            background: white; cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .option-btn.selected { border-color: var(--primary); background: #f0fdf4; color: var(--primary); }
        .footer { padding: 15px 25px 30px; background: white; border-top: 1px solid #f1f5f9; }
        .next-btn { 
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 18px; border-radius: 14px; font-weight: 800; font-size: 15px;
            text-transform: uppercase; cursor: pointer;
        }
        .next-btn:disabled { opacity: 0.5; }
        .admin-view { font-size: 12px; color: #475569; }
        .admin-card { background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="app">
        <div class="header" id="main-header">
             <img id="logo-img" alt="XIGO LOGO" onerror="this.parentElement.innerHTML='<h1 style=\'color:white; font-weight:900;\'>XIGO</h1>'">
        </div>
        <div class="progress-container" id="prog-wrapper">
            <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
            <p id="step-counter" style="font-size: 10px; color: #94a3b8; margin-top: 5px; text-align: right; font-weight: bold;"></p>
        </div>
        <div class="content" id="main-content">
            <div style="text-align: center; padding-top: 40px;">
                <p>Cargando encuesta...</p>
            </div>
        </div>
        <div class="footer" id="footer-actions">
            <button id="next-btn" class="next-btn" style="display: none;">Continuar</button>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE FIREBASE
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-survey-v1';

        // Logo Image Logic
        const rawDriveUrl = "https://drive.google.com/file/d/1WmKpnJPnBgB3OyYqe-a-OgRODLuuPjTq/view?usp=sharing";
        const fileId = rawDriveUrl.match(/\/d\/(.+?)\//)[1];
        document.getElementById('logo-img').src = `https://lh3.googleusercontent.com/u/0/d/${fileId}=w1600-h1600-iv1`;

        const surveyData = [
            { id: 'F1', section: 'FILTRO', type: 'single', q: '¬øEn los √∫ltimos 30 d√≠as, has comprado comida preparada o empacada para consumir fuera de casa?', options: ['S√≠, lo he comprado', 'No, pero lo considerar√≠a', 'No, no me interesa'], terminate: 'No, no me interesa' },
            { id: 'F2', section: 'FILTRO', type: 'single', q: '¬øCu√°l describe mejor tu situaci√≥n actual?', options: ['Trabajo fuera de casa (Oficina/Local)', 'Trabajo desde casa / Online', 'Esquema Mixto', 'Estudiante / No trabajo'] },
            { id: 'C4', section: 'COMIDA', type: 'multi', q: '¬øQu√© tipo de comida te genera m√°s confianza si viene lista y empacada?', options: ['Comida tradicional ecuatoriana', 'Comida casera ligera', 'Bowls balanceados', 'Ensaladas completas', 'Sopas / Cremas', 'Snacks salados'], max: 3 },
            { id: 'P2', section: 'PRECIOS', type: 'single', q: '¬øQu√© precio te parece "Justo" por un men√∫ listo (RTE), fresco y de alta calidad?', options: ['Menos de $4.99', '$5.00 - $6.99', '$7.00 - $8.99', '$9.00 - $10.99', 'M√°s de $11.00'] },
            { id: 'PER2', section: 'PERFIL', type: 'single', q: '¬øEn qu√© zona de Guayaquil realizas la mayor√≠a de tus actividades?', options: ['Norte', 'Centro', 'Sur', 'Samborond√≥n / V√≠a a la Costa', 'V√≠a Daule / Dur√°n'] }
        ];

        let currentStep = 0;
        let answers = {};
        let selectedInStep = [];
        let user = null;
        let adminClicks = 0;

        // INICIO DE SESI√ìN Y CARGA
        async function initApp() {
            try {
                const cred = await auth.signInAnonymously();
                user = cred.user;
                render();
            } catch (e) {
                document.getElementById('main-content').innerHTML = "<p>Error de conexi√≥n. Revisa tu internet.</p>";
            }
        }

        function render() {
            const main = document.getElementById('main-content');
            const nextBtn = document.getElementById('next-btn');
            const fill = document.getElementById('progress-fill');
            const counter = document.getElementById('step-counter');
            
            if (currentStep >= surveyData.length) { renderFinal(); return; }

            const step = surveyData[currentStep];
            selectedInStep = [];
            nextBtn.style.display = 'none';
            fill.style.width = `${(currentStep / surveyData.length) * 100}%`;
            counter.innerText = `Pregunta ${currentStep + 1} de ${surveyData.length}`;

            main.innerHTML = `
                <div style="animation: fadeIn 0.4s ease">
                    <div class="section-tag">${step.section}</div>
                    <h2 class="question-title">${step.q}</h2>
                    <div id="options-grid">
                        ${step.options.map(opt => `
                            <button class="option-btn" onclick="handleSelect('${opt.replace(/'/g, "\\'")}')">${opt}</button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.handleSelect = (val) => {
            const step = surveyData[currentStep];
            const btns = document.querySelectorAll('.option-btn');
            
            if (step.type === 'single') {
                if (step.terminate && val === step.terminate) { renderTermination(); return; }
                answers[step.id] = val;
                btns.forEach(b => b.classList.toggle('selected', b.innerText === val));
                setTimeout(() => { currentStep++; render(); }, 300);
            } else {
                if (selectedInStep.includes(val)) {
                    selectedInStep = selectedInStep.filter(v => v !== val);
                } else {
                    if (selectedInStep.length >= step.max) return;
                    selectedInStep.push(val);
                }
                answers[step.id] = selectedInStep;
                btns.forEach(b => b.classList.toggle('selected', selectedInStep.includes(b.innerText)));
                document.getElementById('next-btn').style.display = selectedInStep.length > 0 ? 'block' : 'none';
            }
        };

        document.getElementById('next-btn').onclick = () => { currentStep++; render(); };

        function renderFinal() {
            document.getElementById('prog-wrapper').classList.add('hidden');
            document.getElementById('footer-actions').classList.add('hidden');
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; padding-top: 20px; animation: fadeIn 0.6s ease">
                    <h2 class="question-title">¬°ENCUESTA COMPLETADA!</h2>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">Ingresa tu correo para recibir tu cup√≥n del 15%.</p>
                    <input type="email" id="user-email" placeholder="Tu correo electr√≥nico" 
                        style="width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 14px; margin-bottom: 20px; text-align: center; font-size: 16px;">
                    <button onclick="saveAndFinish()" id="save-btn" class="next-btn">OBTENER MI CUP√ìN</button>
                </div>
            `;
        }

        async function saveAndFinish() {
            const email = document.getElementById('user-email').value;
            if (!email.includes('@')) { alert("Ingresa un correo v√°lido"); return; }
            if (!user) return;

            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "GUARDANDO...";

            try {
                // GUARDADO EN FIRESTORE (Persistente)
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add({
                    email,
                    answers,
                    uid: user.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('main-content').innerHTML = `
                    <div style="text-align: center; padding-top: 40px; animation: fadeIn 0.6s ease">
                        <div style="font-size: 60px; margin-bottom: 10px;">üç∑</div>
                        <h2 class="question-title" style="color: var(--primary)">¬°LISTO!</h2>
                        <p style="font-size: 14px; color: #64748b;">Tu c√≥digo de descuento es:</p>
                        <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin: 15px 0; font-weight: 800; font-size: 24px; color: var(--primary);">XIGO15</div>
                        <p style="font-size: 12px; color: #94a3b8;">Presenta este c√≥digo en @vinamariaec</p>
                        <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer;">Reiniciar encuesta</button>
                    </div>
                `;
            } catch (e) {
                alert("Error al guardar. Verifica tu conexi√≥n.");
                btn.disabled = false; btn.innerText = "OBTENER MI CUP√ìN";
            }
        }

        function renderTermination() {
            document.getElementById('prog-wrapper').classList.add('hidden');
            document.getElementById('footer-actions').classList.add('hidden');
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; padding-top: 100px; color: #94a3b8;">
                    <p>Gracias por tu tiempo. Esta encuesta busca un perfil espec√≠fico.</p>
                    <button onclick="location.reload()" style="color:var(--primary); font-weight:bold; background:none; border:none; cursor:pointer;">Volver a intentar</button>
                </div>`;
        }

        // PANEL DE ADMINISTRADOR (Click 5 veces en el logo)
        document.getElementById('main-header').onclick = () => {
            adminClicks++;
            if (adminClicks >= 5) {
                const pass = prompt("Contrase√±a de Administrador:");
                if (pass === "XIGO2026") showAdminPanel();
                adminClicks = 0;
            }
        };

        async function showAdminPanel() {
            document.getElementById('prog-wrapper').classList.add('hidden');
            document.getElementById('footer-actions').classList.add('hidden');
            const main = document.getElementById('main-content');
            main.innerHTML = "<h3>Panel Admin: Cargando datos...</h3>";

            try {
                const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').get();
                let html = `<h3>Respuestas Recibidas (${snapshot.size})</h3><div class="admin-view">`;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="admin-card">
                            <strong>${data.email}</strong><br>
                            <small>${new Date(data.timestamp?.seconds * 1000).toLocaleString()}</small><br>
                            <pre style="font-size:10px; background:#eee; padding:5px; overflow:auto;">${JSON.stringify(data.answers, null, 2)}</pre>
                        </div>
                    `;
                });
                html += `</div><button onclick="location.reload()" class="next-btn">Cerrar Admin</button>`;
                main.innerHTML = html;
            } catch (e) {
                main.innerHTML = "Error al cargar datos.";
            }
        }

        initApp();
    </script>
</body>
</html>
