<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XIGO - Encuesta</title>
    
    <!-- Fallback de estilos inmediatos -->
    <style>
        :root { --primary: #2D5A27; --bg: #f3f4f6; }
        body { 
            margin: 0; padding: 0; background: var(--bg); 
            font-family: -apple-system, system-ui, sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        #app { 
            background: white; width: 100%; max-width: 450px; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        @media (min-height: 700px) and (min-width: 500px) {
            #app { height: 800px; border-radius: 30px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        }
        .header { background: var(--primary); height: 140px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .header img { width: 100%; height: 100%; object-fit: cover; }
        .content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .progress-container { padding: 20px 30px 0; background: white; }
        .progress-bar { background: #e5e7eb; height: 6px; border-radius: 10px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: width 0.4s ease; }
        .question-title { font-size: 1.25rem; font-weight: 800; color: #1f2937; line-height: 1.2; margin-bottom: 25px; }
        .option-btn { 
            width: 100%; padding: 16px; margin-bottom: 12px; border: 2px solid #f3f4f6;
            border-radius: 16px; text-align: left; font-weight: 700; color: #4b5563;
            background: white; cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .option-btn:active { transform: scale(0.98); }
        .option-btn.selected { border-color: var(--primary); background: #f0fdf4; color: var(--primary); }
        .footer { padding: 20px 30px 40px; background: white; }
        .next-btn { 
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 18px; border-radius: 16px; font-weight: 900; letter-spacing: 1px;
            text-transform: uppercase; cursor: pointer; display: none;
        }
        .loading-screen { 
            position: absolute; inset: 0; background: white; z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>

    <!-- Firebase SDK (Solo si carga, si no, el app maneja el error) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>

    <div id="app">
        <!-- Pantalla de Carga -->
        <div id="loader" class="loading-screen">
            <div class="spinner"></div>
            <p style="margin-top: 20px; color: #9ca3af; font-weight: 500; font-size: 14px;">Iniciando experiencia XIGO...</p>
        </div>

        <!-- Cabecera -->
        <div class="header">
            <img src="https://i.ibb.co/SD87TqHW/Black-Modern-Minimalist-Letter-A-Logo-1-1.png" alt="Logo XIGO">
        </div>

        <!-- Progreso -->
        <div class="progress-container" id="prog-cont">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>

        <!-- Contenido -->
        <div class="content" id="main-content"></div>

        <!-- Footer -->
        <div class="footer">
            <button id="next-btn" class="next-btn">Siguiente</button>
        </div>
    </div>

    <script>
        // --- DATA DE LA ENCUESTA (BASADA EN TU PDF) ---
        const survey = [
            { id: 'f1', type: 'single', section: 'FILTRO', q: 'Â¿En los Ãºltimos 30 dÃ­as, has comprado comida preparada o empacada para consumir fuera de casa?', options: ['SÃ­, lo he comprado', 'No, pero lo considerarÃ­a', 'No, no me interesa'], terminate: 'No, no me interesa' },
            { id: 'f2', type: 'single', section: 'PERFIL', q: 'Â¿CuÃ¡l describe mejor tu situaciÃ³n actual?', options: ['Trabajo fuera de casa', 'Trabajo desde casa/online', 'Trabajo mixto', 'Estudiante/No trabajo'] },
            { id: 'f3', type: 'single', section: 'HÃBITOS', q: 'Â¿Con quÃ© frecuencia almuerzas fuera de casa en una semana?', options: ['0 veces', '1-2 veces', '3-4 veces', '5+ veces'] },
            { id: 'c1', type: 'multi', section: 'COMIDA', q: 'Â¿En quÃ© situaciones considerarÃ­as consumir comida lista?', options: ['Poco tiempo', 'Reuniones continuas', 'No alcancÃ© a cocinar', 'Comer en oficina', 'Traslados/Viajes', 'Llevar a casa'], max: 6 },
            { id: 'c2', type: 'multi', section: 'COMIDA', q: 'Â¿QuÃ© tipo de comida te genera mÃ¡s confianza empacada? (MÃ¡x 3)', options: ['Ecuatoriana tradicional', 'Casera ligera', 'Bowls balanceados', 'Ensaladas completas', 'Sopas / Cremas', 'Snacks salados'], max: 3 },
            { id: 'p1', type: 'single', section: 'PRECIOS', q: 'Â¿CuÃ¡nto pagas hoy por tu almuerzo promedio?', options: ['Menos de $4.99', '$5.99 - $7.99', '$7.99 - $9.99', '$10+'] },
            { id: 'r1', type: 'multi', section: 'BEBIDAS', q: 'Â¿QuÃ© bebidas te resultan mÃ¡s atractivas? (MÃ¡x 2)', options: ['Agua natural/saborizada', 'Jugo natural prensado', 'TÃ© frÃ­o / InfusiÃ³n', 'CafÃ© Latte / Matcha', 'Bebida funcional'], max: 2 },
            { id: 'e1', type: 'single', section: 'PERFIL', q: 'Â¿En quÃ© zona realizas la mayorÃ­a de tus actividades?', options: ['Norte', 'Centro', 'Sur', 'SamborondÃ³n / VÃ­a Costa', 'DurÃ¡n'] }
        ];

        let currentStep = 0;
        let answers = {};
        let selectedInStep = [];
        let db, appId;

        // --- INICIALIZACIÃ“N ---
        window.onload = async () => {
            const loader = document.getElementById('loader');
            
            try {
                // Verificar Firebase
                if (typeof firebase !== 'undefined' && typeof __firebase_config !== 'undefined') {
                    const config = JSON.parse(__firebase_config);
                    firebase.initializeApp(config);
                    db = firebase.firestore();
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-survey-1';
                    await firebase.auth().signInAnonymously();
                }
            } catch (e) {
                console.warn("Firebase no disponible, usando modo offline temporal.");
            }

            loader.classList.add('hidden');
            render();
        };

        function render() {
            const main = document.getElementById('main-content');
            const nextBtn = document.getElementById('next-btn');
            const progress = document.getElementById('progress-fill');
            
            if (currentStep >= survey.length) {
                renderEmailCollector();
                return;
            }

            const step = survey[currentStep];
            selectedInStep = [];
            nextBtn.style.display = 'none';
            progress.style.width = `${(currentStep / survey.length) * 100}%`;

            let optionsHtml = step.options.map(opt => `
                <button class="option-btn" onclick="handleSelect('${opt.replace(/'/g, "\\'")}')">${opt}</button>
            `).join('');

            main.innerHTML = `
                <div style="animation: fadeIn 0.4s ease">
                    <p style="color: var(--primary); font-size: 10px; font-weight: 800; letter-spacing: 2px; margin-bottom: 5px;">${step.section}</p>
                    <h2 class="question-title">${step.q}</h2>
                    <div id="options-grid">${optionsHtml}</div>
                </div>
            `;
        }

        window.handleSelect = (val) => {
            const step = survey[currentStep];
            const btns = document.querySelectorAll('.option-btn');
            
            if (step.type === 'single') {
                if (step.terminate && val === step.terminate) {
                    renderTermination();
                    return;
                }
                
                answers[step.id] = val;
                btns.forEach(b => {
                    b.classList.toggle('selected', b.innerText === val);
                });

                setTimeout(() => {
                    currentStep++;
                    render();
                }, 300);
            } else {
                if (selectedInStep.includes(val)) {
                    selectedInStep = selectedInStep.filter(v => v !== val);
                } else {
                    if (step.max && selectedInStep.length >= step.max) return;
                    selectedInStep.push(val);
                }
                
                answers[step.id] = selectedInStep;
                btns.forEach(b => {
                    b.classList.toggle('selected', selectedInStep.includes(b.innerText));
                });

                document.getElementById('next-btn').style.display = selectedInStep.length > 0 ? 'block' : 'none';
            }
        };

        document.getElementById('next-btn').onclick = () => {
            currentStep++;
            render();
        };

        function renderEmailCollector() {
            document.getElementById('prog-cont').classList.add('hidden');
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; padding-top: 40px;">
                    <h2 class="question-title">Â¡HAS TERMINADO!</h2>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 30px;">Ingresa tu correo para recibir tu cupÃ³n de descuento.</p>
                    <input type="email" id="email" placeholder="correo@ejemplo.com" 
                        style="width: 100%; padding: 18px; border: 2px solid #e5e7eb; border-radius: 16px; margin-bottom: 20px; font-size: 16px; text-align: center; box-sizing: border-box;">
                    <button onclick="finish()" id="finish-btn" 
                        style="width: 100%; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 16px; font-weight: 900; cursor: pointer;">
                        OBTENER CUPÃ“N
                    </button>
                </div>
            `;
        }

        async function finish() {
            const email = document.getElementById('email').value;
            if (!email.includes('@')) {
                alert("Por favor ingresa un email vÃ¡lido");
                return;
            }

            const btn = document.getElementById('finish-btn');
            btn.disabled = true;
            btn.innerText = "PROCESANDO...";

            try {
                if (db) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add({
                        email,
                        answers,
                        timestamp: new Date().toISOString()
                    });
                }
                
                document.getElementById('main-content').innerHTML = `
                    <div style="text-align: center; padding-top: 60px;">
                        <div style="font-size: 50px; margin-bottom: 20px;">ðŸŽ‰</div>
                        <h2 class="question-title" style="color: var(--primary)">Â¡GRACIAS!</h2>
                        <p style="color: #4b5563; font-weight: 600;">Tu cupÃ³n de 15% ha sido enviado a tu correo.</p>
                        <p style="color: #9ca3af; font-size: 12px; margin-top: 20px;">Revisa tu bandeja de entrada o spam.</p>
                    </div>
                `;
            } catch (e) {
                alert("Error al guardar: " + e.message);
                btn.disabled = false;
                btn.innerText = "OBTENER CUPÃ“N";
            }
        }

        function renderTermination() {
            document.getElementById('prog-cont').classList.add('hidden');
            document.getElementById('main-content').innerHTML = `
                <div style="text-align: center; padding-top: 60px; color: #9ca3af;">
                    <p>Gracias por tu tiempo. Por ahora buscamos otros perfiles de consumo.</p>
                </div>
            `;
        }
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>
