import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// --- CONFIGURACI√ìN DE SEGURIDAD ---
const ADMIN_PASSWORD = "XIGO2026"; // <--- CAMBIA TU CONTRASE√ëA AQU√ç

// --- CONFIGURACI√ìN DE FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-survey-default';

const surveyData = [
  {
    section: "Bloque 0 - Filtro",
    title: "¬øEn los √∫ltimos 30 d√≠as, has comprado comida preparada para consumir fuera de casa, trabajo o universidad?",
    options: ["S√≠, lo he comprado", "No, pero lo considerar√≠a si fuera conveniente", "No, no me interesa"],
    type: "single",
    terminateIf: "No, no me interesa"
  },
  {
    section: "Bloque 1 - Estilo de Vida",
    title: "¬øCu√°l describe mejor tu situaci√≥n actual?",
    options: ["Trabajo fuera de casa", "Trabajo desde casa/online", "Trabajo mixto", "Estudiante / No trabajo"],
    type: "single"
  },
  {
    section: "Bloque 1 - Comida",
    title: "¬øHas comprado alguna vez comida preparada para consumir despu√©s (Refrigerada/Empacada)?",
    options: ["S√≠, regularmente", "S√≠, algunas veces", "No, pero me llama la atenci√≥n", "No, no me interesa"],
    type: "single"
  },
  {
    section: "Bloque 1 - Momentos",
    title: "¬øEn qu√© situaciones elegir√≠as comida lista para llevar? (Puedes elegir varias)",
    options: ["Poco tiempo para almorzar", "Reuniones de trabajo", "No alcanc√© a cocinar", "Comer en la oficina", "Entre traslados", "Para llevar a casa"],
    type: "multiple"
  },
  {
    section: "Bloque 1 - Preferencias",
    title: "¬øQu√© tipo de comida te genera m√°s apetito en formato Grab & Go? (Elige hasta 3)",
    options: ["Ecuatoriana", "Casera ligera", "Bowls balanceados", "Ensaladas", "Sopas/Cremas", "Snacks salados"],
    type: "multiple",
    max: 3
  },
  {
    section: "Bloque 2 - Precios",
    title: "¬øQu√© precio te parece razonable para un almuerzo fresco y de calidad?",
    options: ["$5.99 - $7.99", "$7.99 - $9.99", "$9.99 - $11.99", "$12.00+"],
    type: "single"
  },
  {
    section: "Bloque 2 - Elasticidad",
    title: "Si un almuerzo de $5.99 sube a $7.99 por costos de ingredientes, ¬øqu√© har√≠as?",
    options: ["Lo seguir√≠a comprando igual", "Lo comprar√≠a con menos frecuencia", "Buscar√≠a otra opci√≥n", "Dejar√≠a de comprarlo"],
    type: "single"
  },
  {
    section: "Bloque 3 - Bebidas",
    title: "¬øCu√°l de estas opciones de bebida te resultar√≠a m√°s atractiva? (Elige 2)",
    options: ["Agua natural/saborizada", "Jugo natural prensado", "T√© fr√≠o / Infusi√≥n", "Caf√© latte / Macha", "Bebida funcional", "Bebida refrescante"],
    type: "multiple",
    max: 2
  },
  {
    section: "Bloque 3 - L√°cteos",
    title: "¬øQu√© tipo de leche prefieres en tus bebidas? (Elige hasta 2)",
    options: ["Leche entera", "Deslactosada", "Almendra", "Avena", "Soya", "No consumo leche"],
    type: "multiple",
    max: 2
  },
  {
    section: "Bloque 4 - Perfil",
    title: "¬øEn qu√© zona de Guayaquil realizas tus actividades principales?",
    options: ["Norte", "Centro", "Sur", "Samborond√≥n", "V√≠a a la Costa", "Dur√°n"],
    type: "single"
  },
  {
    section: "Bloque 4 - Perfil",
    title: "Rango de edad",
    options: ["18-24", "25-34", "35-44", "45-54", "55+"],
    type: "single"
  }
];

export default function App() {
  const [user, setUser] = useState(null);
  const [step, setStep] = useState('survey'); 
  const [currentIdx, setCurrentIdx] = useState(0);
  const [answers, setAnswers] = useState({});
  const [selectedInStep, setSelectedInStep] = useState([]);
  const [email, setEmail] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [allData, setAllData] = useState([]);
  const [clickCount, setClickCount] = useState(0);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user || step !== 'admin') return;
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'respuestas');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setAllData(data);
    }, (error) => console.error("Error fetching data:", error));
    return () => unsubscribe();
  }, [user, step]);

  const handleAdminAccess = () => {
    const newCount = clickCount + 1;
    if (newCount >= 5) {
      const pass = prompt("Introduce la clave de acceso de XIGO:");
      if (pass === ADMIN_PASSWORD) {
        setStep('admin');
      } else {
        alert("Clave incorrecta.");
      }
      setClickCount(0);
    } else {
      setClickCount(newCount);
    }
  };

  const saveData = async (finalAnswers, status = 'completado', userEmail = '') => {
    if (!user) return;
    const payload = {
      ...finalAnswers,
      email: userEmail,
      status,
      timestamp: new Date().toISOString(),
      userId: user.uid
    };
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'respuestas'), payload);
    } catch (e) {
      console.error("Error al guardar:", e);
    }
  };

  const handleSelect = (val) => {
    const q = surveyData[currentIdx];
    if (q.type === 'single') {
      const newAnswers = { ...answers, [q.title]: val };
      setAnswers(newAnswers);
      setSelectedInStep([val]);
      if (q.terminateIf && val === q.terminateIf) {
        saveData(newAnswers, 'terminado_temprano');
        setStep('terminated');
      } else {
        setTimeout(() => nextStep(newAnswers), 400);
      }
    } else {
      let updated = selectedInStep.includes(val) 
        ? selectedInStep.filter(i => i !== val) 
        : (q.max && selectedInStep.length >= q.max ? selectedInStep : [...selectedInStep, val]);
      setSelectedInStep(updated);
      setAnswers({ ...answers, [q.title]: updated });
    }
  };

  const nextStep = () => {
    if (currentIdx < surveyData.length - 1) {
      setCurrentIdx(currentIdx + 1);
      setSelectedInStep([]);
    } else {
      setStep('email');
    }
  };

  const submitEmail = async () => {
    if (!email.includes('@')) return;
    setIsLoading(true);
    await saveData(answers, 'completado', email);
    setIsLoading(false);
    setStep('success');
  };

  const downloadCSV = () => {
    if (allData.length === 0) return;
    const allKeys = new Set();
    allData.forEach(d => Object.keys(d).forEach(k => allKeys.add(k)));
    const headers = Array.from(allKeys).filter(k => k !== 'id');
    const csvRows = [headers.join(','), ...allData.map(row => headers.map(h => `"${String(row[h] || '').replace(/"/g, '""')}"`).join(','))];
    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `datos_xigo_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };

  if (step === 'admin') {
    return (
      <div className="p-6 bg-white min-h-screen">
        <div className="flex justify-between items-center mb-8 border-b pb-4">
          <h1 className="text-2xl font-bold text-xigo">Resultados XIGO</h1>
          <button onClick={() => setStep('survey')} className="text-gray-400 font-bold hover:text-gray-600">CERRAR</button>
        </div>
        <div className="flex flex-wrap gap-4 mb-8">
          <button onClick={downloadCSV} className="bg-xigo text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-all">
            Descargar CSV para Drive / Excel
          </button>
          <div className="bg-gray-50 px-6 py-3 rounded-xl border border-gray-100 flex items-center">
            <span className="text-gray-500 text-sm font-medium">Total de registros: <strong className="text-xigo">{allData.length}</strong></span>
          </div>
        </div>
        <div className="overflow-x-auto rounded-2xl border border-gray-100 shadow-sm">
          <table className="min-w-full text-xs">
            <thead>
              <tr className="bg-gray-50 text-gray-400 uppercase tracking-widest">
                <th className="p-4 text-left border-b">Fecha</th>
                <th className="p-4 text-left border-b">Email</th>
                <th className="p-4 text-left border-b">Estado</th>
              </tr>
            </thead>
            <tbody>
              {allData.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map((d, i) => (
                <tr key={i} className="border-b last:border-0 hover:bg-gray-50">
                  <td className="p-4 text-gray-400">{new Date(d.timestamp).toLocaleString()}</td>
                  <td className="p-4 font-bold text-gray-800">{d.email || 'An√≥nimo'}</td>
                  <td className="p-4">
                    <span className={`px-3 py-1 rounded-full text-[10px] font-black ${d.status === 'completado' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>
                      {d.status.toUpperCase()}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50 font-sans text-gray-900">
      <div className="bg-white w-full max-w-lg rounded-[3rem] shadow-2xl overflow-hidden flex flex-col min-h-[650px] border border-white">
        
        {/* HEADER - Haz 5 clics aqu√≠ para entrar como Admin */}
        <div onClick={handleAdminAccess} className="bg-xigo p-8 text-center relative overflow-hidden cursor-pointer active:opacity-90 transition-opacity">
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-16 -mt-16"></div>
          <h1 className="text-white font-black text-4xl tracking-[0.25em] mb-1">XIGO</h1>
          <p className="text-green-100 text-[10px] uppercase tracking-widest font-bold opacity-80 italic">Grab & Go ‚Ä¢ Calidad Premium</p>
        </div>

        <div className="p-8 sm:p-12 flex-grow flex flex-col">
          {step === 'survey' && (
            <div className="fade-in flex-grow">
              <div className="w-full bg-gray-100 h-1 rounded-full mb-10 overflow-hidden">
                <div className="bg-xigo h-full transition-all duration-1000" style={{ width: `${(currentIdx / surveyData.length) * 100}%` }}></div>
              </div>
              <p className="text-xigo font-black text-[10px] uppercase mb-3 tracking-widest">{surveyData[currentIdx].section}</p>
              <h2 className="text-2xl font-black text-gray-800 leading-[1.1] mb-8">{surveyData[currentIdx].title}</h2>
              <div className="space-y-3">
                {surveyData[currentIdx].options.map((opt, i) => (
                  <button 
                    key={i} 
                    onClick={() => handleSelect(opt)}
                    className={`w-full p-5 rounded-2xl text-left font-bold transition-all border-2 text-sm
                      ${selectedInStep.includes(opt) ? 'border-xigo bg-green-50 text-xigo' : 'border-gray-50 bg-white text-gray-600 hover:border-gray-200'}`}
                  >
                    {opt}
                  </button>
                ))}
              </div>
              {surveyData[currentIdx].type === 'multiple' && selectedInStep.length > 0 && (
                <button onClick={nextStep} className="mt-8 w-full bg-xigo text-white font-black py-5 rounded-2xl shadow-xl uppercase tracking-widest hover:opacity-90">Continuar</button>
              )}
            </div>
          )}

          {step === 'email' && (
            <div className="fade-in text-center py-10">
              <div className="text-4xl mb-6">üéÅ</div>
              <h2 className="text-2xl font-black text-gray-800 mb-2 uppercase italic">¬°Excelente!</h2>
              <p className="text-gray-500 text-sm mb-8 leading-relaxed">Solo d√©janos tu correo para enviarte el c√≥digo de descuento del <strong>15%</strong> y la invitaci√≥n a nuestra apertura.</p>
              <input 
                type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="correo@ejemplo.com"
                className="w-full p-5 rounded-2xl border-2 border-gray-100 focus:border-xigo outline-none mb-4 text-center font-bold text-gray-800"
              />
              <button onClick={submitEmail} disabled={isLoading} className="w-full bg-xigo text-white font-black py-5 rounded-2xl shadow-xl uppercase tracking-widest disabled:opacity-50">
                {isLoading ? "Guardando..." : "Obtener mi Regalo"}
              </button>
            </div>
          )}

          {step === 'success' && (
            <div className="fade-in text-center py-10">
              <div className="w-20 h-20 bg-green-100 text-xigo rounded-full flex items-center justify-center text-3xl mx-auto mb-8">‚úì</div>
              <h2 onClick={handleAdminAccess} className="text-3xl font-black text-xigo mb-4 uppercase italic cursor-pointer">¬°TODO LISTO!</h2>
              <p className="text-gray-600 mb-8 font-medium">Hemos registrado tu participaci√≥n. El c√≥digo <strong>XIGO15</strong> llegar√° pronto a <br/><span className="text-xigo font-bold">{email}</span></p>
              <div className="bg-gray-50 border-2 border-dashed border-gray-200 p-8 rounded-[2.5rem]">
                <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Revisa tu bandeja de entrada</p>
              </div>
            </div>
          )}

          {step === 'terminated' && (
            <div className="fade-in text-center py-10">
              <h2 className="text-2xl font-black text-gray-800 mb-4 uppercase italic">¬°Gracias!</h2>
              <p className="text-gray-500 text-sm mb-10 leading-relaxed">Apreciamos tu tiempo. Tus respuestas nos ayudan a entender mejor el mercado aunque hoy no califiques para la promoci√≥n.</p>
              <button onClick={() => window.location.reload()} className="text-xigo font-bold underline">Volver al inicio</button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
