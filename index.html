<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XIGO - Encuesta de Mercado Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js"
      }
    }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        xigo: '#2D5A27',
                        'xigo-light': '#f0fdf4',
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #2D5A27; border-radius: 10px; }
        .header-bg { background-color: #2D5A27; display: flex; align-items: center; justify-content: center; overflow: hidden; height: 180px; }
        .header-img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "firebase/firestore";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "firebase/auth";

        // Hacer Firebase disponible globalmente para el script de Babel
        window.FB = { initializeApp, getFirestore, collection, addDoc, onSnapshot, query, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Configuraci√≥n y constantes
        const ADMIN_PASSWORD = "XIGO2026"; 
        const LOGO_URL = "https://i.ibb.co/SD87TqHW/Black-Modern-Minimalist-Letter-A-Logo-1-1.png"; 

        // Inicializar Firebase usando el puente global
        const { initializeApp, getFirestore, collection, addDoc, onSnapshot, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.FB;
        
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-survey-v1';

        const surveyData = [
            { section: "Filtro", title: "¬øEn los √∫ltimos 30 d√≠as, has comprado comida preparada o empacada para consumir fuera de casa?", options: ["S√≠, lo he comprado", "No, pero lo considerar√≠a", "No, no me interesa"], type: "single", terminateIf: "No, no me interesa" },
            { section: "Filtro", title: "¬øCu√°l describe mejor tu situaci√≥n actual?", options: ["Trabajo fuera de casa", "Trabajo desde casa / Online", "Trabajo mixto", "Estudiante / No trabajo"], type: "single" },
            { section: "Filtro", title: "¬øCon qu√© frecuencia almuerzas fuera de casa en una semana laboral?", options: ["0 veces", "1 a 2 veces", "3 a 4 veces", "5 veces (todos los d√≠as)"], type: "single" },
            { section: "Comida", title: "¬øHas comprado alguna vez comida preparada para consumir despu√©s (Refrigerada o en tarrinas)?", options: ["S√≠, regularmente", "S√≠, algunas veces", "No, pero me llama la atenci√≥n", "No, no me interesa"], type: "single" },
            { section: "Comida", title: "¬øEn qu√© situaciones elegir√≠as comida lista durante un d√≠a laboral?", options: ["Poco tiempo", "Reuniones continuas", "No alcanc√© a cocinar", "Para comer en oficina", "Traslados", "Para llevar a casa"], type: "multiple" },
            { section: "Comida", title: "¬øQu√© tipo de comida te genera m√°s confianza empacada? (M√°x 3)", options: ["Tradicional ecuatoriana", "Casera ligera", "Bowls balanceados", "Ensaladas completas", "Sopas / Cremas", "Snacks salados"], type: "multiple", max: 3 },
            { section: "Comida", title: "Para tu almuerzo o cena, ¬øqu√© tama√±o de porci√≥n prefieres?", options: ["Ligero", "Normal", "Grande", "Depende del d√≠a"], type: "single" },
            { section: "Comida", title: "¬øQu√© esperas de un almuerzo para que 'valga la pena'? (M√°x 3)", options: ["Porci√≥n generosa", "Saludable/Balanceado", "Mucha prote√≠na", "R√°pido y pr√°ctico", "Excelente sabor"], type: "multiple", max: 3 },
            { section: "Comida", title: "¬øQu√© factor te har√≠a dudar al comprar comida lista? (M√°x 3)", options: ["Frescura", "Higiene", "Sabor", "Precio", "Tama√±o porci√≥n", "Conservantes", "Caducidad", "Empaque"], type: "multiple", max: 3 },
            { section: "Comida", title: "Si tuvieras acceso a comida fresca cerca, ¬øcon qu√© frecuencia la consumir√≠as?", options: ["Nunca", "1 vez/semana", "2-3 veces/semana", "Casi todos los d√≠as"], type: "single" },
            { section: "Comida", title: "¬øConsiderar√≠as pedir comida lista por delivery si fuera de alta calidad?", options: ["S√≠, con frecuencia", "S√≠, ocasionalmente", "Tal vez", "No"], type: "single" },
            { section: "Precios", title: "¬øCu√°nto sueles pagar por tu almuerzo promedio entre semana?", options: ["Menos de $4.99", "$5.00 a $7.99", "$8.00 a $9.99", "$10.00 a $11.99", "$12.00 o m√°s"], type: "single" },
            { section: "Precios", title: "¬øQu√© precio te parece razonable para un almuerzo fresco y balanceado?", options: ["Menos de $4.99", "$5.00 a $7.99", "$8.00 a $9.99", "$10.00 a $11.99", "$12.00 o m√°s"], type: "single" },
            { section: "Precios", title: "¬øA partir de qu√© precio considerar√≠as que un almuerzo listo es demasiado CARO?", options: ["Menos de $4.99", "$5.00 a $7.99", "$8.00 a $9.99", "$10.00 a $11.99", "$12.00 o m√°s"], type: "single" },
            { section: "Precios", title: "¬øQu√© formato de compra te resultar√≠a m√°s atractivo?", options: ["Pedido puntual", "Pack 2-3 d√≠as", "Pack semana laboral", "No me interesa"], type: "single" },
            { section: "Precios", title: "Si tu almuerzo de $5.99 sube a $7.99 por costos, ¬øqu√© har√≠as?", options: ["Seguir comprando", "Menos frecuencia", "Buscar otra opci√≥n", "Dejar de comprar"], type: "single" },
            { section: "Bebidas", title: "¬øCompras bebidas listas para tomar (agua, jugos, t√©s) en el trabajo?", options: ["Diario", "Varias veces/semana", "Ocasionalmente", "Rara vez", "Nunca"], type: "single" },
            { section: "Bebidas", title: "¬øCu√°l opci√≥n te resultar√≠a m√°s atractiva? (M√°x 2)", options: ["Agua natural/saborizada", "Jugo natural prensado", "T√© fr√≠o/Infusi√≥n", "Caf√©/Matcha", "Bebida funcional", "Refrescante"], type: "multiple", max: 2 },
            { section: "Bebidas", title: "En caf√© o smoothies, ¬øqu√© tipo de leche prefieres? (M√°x 2)", options: ["Entera", "Deslactosada", "Almendra", "Avena", "Soya", "Sin leche"], type: "multiple", max: 2 },
            { section: "Bebidas", title: "¬øQu√© precio te parece razonable para una bebida RTD premium?", options: ["Hasta $1.99", "$2.00-$2.99", "$3.00-$3.99", "$4.00-$4.99", "+$5.00"], type: "single" },
            { section: "Perfil", title: "¬øEn qu√© rango de edad te encuentras?", options: ["18-24", "25-34", "35-44", "45-54", "55+"], type: "single" },
            { section: "Perfil", title: "¬øCu√°l es tu g√©nero?", options: ["Femenino", "Masculino", "Otro"], type: "single" },
            { section: "Perfil", title: "¬øEn qu√© zona de Guayaquil realizas tus actividades?", options: ["Norte", "Centro", "Sur", "Samborond√≥n/V√≠a Costa", "Dur√°n"], type: "single" }
        ];

        function App() {
            const [step, setStep] = useState('survey');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [selectedInStep, setSelectedInStep] = useState([]);
            const [email, setEmail] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [adminClicks, setAdminClicks] = useState(0);
            const [database, setDatabase] = useState([]);
            const [selectedUser, setSelectedUser] = useState(null);
            const [user, setUser] = useState(null);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Auth error", e); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const responsesRef = collection(db, 'artifacts', appId, 'public', 'data', 'responses');
                const unsubscribe = onSnapshot(responsesRef, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setDatabase(docs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
                }, (error) => {
                    console.error("Error fetching data:", error);
                });
                return () => unsubscribe();
            }, [user]);

            const handleAdminAccess = () => {
                const clicks = adminClicks + 1;
                if (clicks >= 5) {
                    const p = prompt("Password Admin:");
                    if (p === ADMIN_PASSWORD) setStep('admin');
                    setAdminClicks(0);
                } else setAdminClicks(clicks);
            };

            const downloadExcel = () => {
                if (database.length === 0) return alert("No hay datos para descargar");
                const clean = (text) => !text ? "" : `"${String(text).replace(/"/g, '""')}"`;
                const headers = ["ID", "Fecha", "Email", ...surveyData.map(q => q.title)];
                const rows = database.map(u => {
                    const rowData = [u.id, u.date, u.email];
                    surveyData.forEach(q => {
                        const ans = u.responses?.[q.title]?.value || "Sin respuesta";
                        rowData.push(Array.isArray(ans) ? ans.join(" | ") : ans);
                    });
                    return rowData.map(clean).join(";");
                });
                const csvContent = "\uFEFF" + [headers.map(clean).join(";"), ...rows].join("\r\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `XIGO_Data_Cloud_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            };

            const handleSelect = (val) => {
                const q = surveyData[currentIdx];
                if (q.type === 'single') {
                    setAnswers({...answers, [q.title]: { value: val, section: q.section }});
                    setSelectedInStep([val]);
                    if (q.terminateIf && val === q.terminateIf) return setStep('terminated');
                    setTimeout(() => {
                        if (currentIdx < surveyData.length - 1) {
                            setCurrentIdx(currentIdx + 1);
                            setSelectedInStep([]);
                        } else setStep('email');
                    }, 300);
                } else {
                    let updated = selectedInStep.includes(val) 
                        ? selectedInStep.filter(i => i !== val) 
                        : (q.max && selectedInStep.length >= q.max ? selectedInStep : [...selectedInStep, val]);
                    setSelectedInStep(updated);
                    setAnswers({...answers, [q.title]: { value: updated, section: q.section }});
                }
            };

            const submitSurvey = async () => {
                if (!email.includes('@')) return alert("Email inv√°lido");
                if (!user) return alert("Error de conexi√≥n. Intenta de nuevo.");
                
                setIsLoading(true);
                try {
                    const responsesRef = collection(db, 'artifacts', appId, 'public', 'data', 'responses');
                    await addDoc(responsesRef, {
                        email,
                        date: new Date().toLocaleString(),
                        timestamp: new Date().toISOString(),
                        responses: answers,
                        userId: user.uid
                    });
                    setIsLoading(false);
                    setStep('success');
                } catch (e) {
                    setIsLoading(false);
                    alert("Error al guardar en la nube: " + e.message);
                }
            };

            if (step === 'admin') return (
                <div className="min-h-screen bg-gray-50 p-4 font-sans overflow-y-auto">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-6 rounded-3xl shadow-sm border gap-4">
                            <div className="flex items-center gap-4">
                                <img src={LOGO_URL} className="h-10 w-auto" alt="XIGO Logo" />
                                <h1 className="text-xl font-black text-xigo">BASE DE DATOS EN LA NUBE</h1>
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={downloadExcel}
                                    className="bg-xigo text-white px-6 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-green-800 transition-all shadow-md active:scale-95"
                                >
                                    <span>üì•</span> EXCEL ACTUALIZADO
                                </button>
                                <button onClick={() => setStep('survey')} className="bg-gray-100 px-4 py-2 rounded-xl text-xs font-bold hover:bg-gray-200 transition-colors">Salir</button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="space-y-2 max-h-[600px] overflow-y-auto custom-scrollbar bg-white p-4 rounded-3xl border shadow-sm">
                                <p className="text-[10px] font-black text-gray-400 uppercase ml-2 mb-2 tracking-widest">Registros en Nube ({database.length})</p>
                                {database.map(u => (
                                    <div 
                                        key={u.id} 
                                        onClick={() => setSelectedUser(u)} 
                                        className={`p-4 rounded-2xl cursor-pointer border transition-all ${selectedUser?.id === u.id ? 'bg-xigo text-white border-xigo shadow-lg scale-[1.02]' : 'bg-white text-gray-700 hover:border-xigo hover:text-xigo'}`}
                                    >
                                        <p className="font-bold truncate text-sm">{u.email}</p>
                                        <p className={`text-[10px] uppercase ${selectedUser?.id === u.id ? 'text-green-100' : 'text-gray-400'}`}>{u.date}</p>
                                    </div>
                                ))}
                            </div>

                            <div className="lg:col-span-2 bg-white rounded-3xl p-6 border shadow-sm min-h-[500px]">
                                {selectedUser ? (
                                    <div className="fade-in">
                                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                                            <div>
                                                <h3 className="text-xl font-black text-gray-800">{selectedUser.email}</h3>
                                                <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">UID: {selectedUser.userId}</p>
                                            </div>
                                            <span className="text-[10px] font-black bg-xigo-light text-xigo px-3 py-1.5 rounded-full border border-green-100">{selectedUser.date}</span>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                                            {surveyData.map((q, i) => {
                                                const userAns = selectedUser.responses?.[q.title];
                                                return (
                                                    <div key={i} className="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <span className="bg-white text-xigo text-[9px] font-black px-2 py-0.5 rounded border border-green-100 uppercase tracking-tighter">{q.section}</span>
                                                        </div>
                                                        <p className="text-[11px] font-bold text-gray-500 mb-2 leading-tight">{q.title}</p>
                                                        <p className="text-sm font-black text-xigo">
                                                            {userAns ? (Array.isArray(userAns.value) ? userAns.value.join(", ") : userAns.value) : "Sin respuesta"}
                                                        </p>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-gray-300 py-20 text-center">
                                        <div className="bg-gray-50 p-6 rounded-full mb-4">‚òÅÔ∏è</div>
                                        <p className="font-bold">Datos sincronizados con la nube</p>
                                        <p className="text-xs mt-1">Selecciona un registro para ver el detalle completo</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4 font-sans">
                    <div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[700px] border">
                        <div onClick={handleAdminAccess} className="header-bg flex-shrink-0 cursor-pointer">
                            <img src={LOGO_URL} className="header-img" alt="XIGO Header" />
                        </div>
                        <div className="p-8 flex-grow flex flex-col overflow-hidden">
                            {step === 'survey' && (
                                <div className="fade-in h-full flex flex-col">
                                    <div className="w-full bg-gray-100 h-1 rounded-full mb-6">
                                        <div className="bg-xigo h-full transition-all duration-500" style={{width: `${((currentIdx+1)/surveyData.length)*100}%`}}></div>
                                    </div>
                                    <div className="flex-grow overflow-y-auto custom-scrollbar pr-1">
                                        <p className="text-xigo font-black text-[9px] uppercase tracking-widest mb-1 opacity-60">{surveyData[currentIdx].section}</p>
                                        <h2 className="text-lg font-black text-gray-800 leading-tight mb-6">{surveyData[currentIdx].title}</h2>
                                        <div className="space-y-2">
                                            {surveyData[currentIdx].options.map(o => (
                                                <button key={o} onClick={() => handleSelect(o)} className={`w-full p-4 rounded-2xl text-left text-sm font-bold border-2 transition-all ${selectedInStep.includes(o) ? 'border-xigo bg-xigo-light text-xigo shadow-sm' : 'border-gray-50 text-gray-600 hover:border-gray-200'}`}>{o}</button>
                                            ))}
                                        </div>
                                    </div>
                                    {surveyData[currentIdx].type === 'multiple' && selectedInStep.length > 0 && (
                                        <button onClick={() => {setCurrentIdx(currentIdx+1); setSelectedInStep([])}} className="mt-4 w-full bg-xigo text-white py-4 rounded-2xl font-black uppercase tracking-widest">Siguiente</button>
                                    )}
                                </div>
                            )}
                            {step === 'email' && (
                                <div className="fade-in text-center flex flex-col justify-center h-full">
                                    <h2 className="text-2xl font-black mb-4 tracking-tighter">¬°CASI LISTO!</h2>
                                    <p className="text-sm text-gray-500 mb-8 font-medium">Completa tu correo para recibir el cup√≥n de **Vina Mar√≠a** y guardar tus respuestas.</p>
                                    <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="tu@email.com" className="p-4 border-2 rounded-2xl mb-4 text-center font-bold outline-none focus:border-xigo"/>
                                    <button onClick={submitSurvey} disabled={isLoading} className="bg-xigo text-white py-4 rounded-2xl font-black uppercase tracking-widest w-full">
                                        {isLoading ? "GUARDANDO EN NUBE..." : "FINALIZAR"}
                                    </button>
                                </div>
                            )}
                            {step === 'success' && (
                                <div className="fade-in text-center flex flex-col justify-center h-full">
                                    <div className="text-5xl mb-4 animate-bounce">‚úÖ</div>
                                    <h2 className="text-2xl font-black text-xigo">¬°REGISTRADO!</h2>
                                    <p className="text-gray-500 text-sm mt-2 font-medium">Tus respuestas se han guardado de forma permanente en la nube de XIGO.</p>
                                    <button onClick={() => window.location.reload()} className="mt-8 text-xigo font-bold text-xs underline uppercase tracking-widest">Nueva encuesta</button>
                                </div>
                            )}
                            {step === 'terminated' && (
                                <div className="fade-in text-center flex flex-col justify-center h-full text-gray-400">
                                    <h2 className="text-xl font-black mb-4 uppercase">Gracias por tu inter√©s</h2>
                                    <p className="text-sm mb-8">Esta encuesta es para consumidores activos.</p>
                                    <button onClick={() => window.location.reload()} className="text-xigo font-bold text-xs underline uppercase tracking-widest">Reiniciar</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
