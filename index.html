<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>XIGO - Encuesta</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK Compat (Versión estable) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* Estilos críticos integrados para evitar pantalla en blanco */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .header-bg { background-color: #2D5A27; height: 160px; display: flex; align-items: center; justify-content: center; }
        .header-img { width: 100%; height: 100%; object-fit: cover; }
        .hide { display: none !important; }
        .option-btn.selected { border-color: #2D5A27; background-color: #f0fdf4; color: #2D5A27; }
        #app-container { opacity: 0; transition: opacity 0.3s ease-in; }
        #app-container.visible { opacity: 1; }
    </style>
</head>
<body>

    <div id="app-container" class="bg-white w-full h-full sm:max-w-md sm:h-[800px] sm:rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col border border-gray-100">
        <!-- Header -->
        <div class="header-bg flex-shrink-0" id="admin-trigger">
            <img src="https://i.ibb.co/SD87TqHW/Black-Modern-Minimalist-Letter-A-Logo-1-1.png" class="header-img" alt="XIGO">
        </div>

        <!-- Barra de Progreso -->
        <div id="progress-container" class="px-8 pt-6">
            <div class="w-full bg-gray-100 h-1.5 rounded-full">
                <div id="progress-bar" class="bg-[#2D5A27] h-full rounded-full transition-all duration-500" style="width: 5%"></div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div id="main-content" class="flex-1 p-8 flex flex-col overflow-y-auto">
            <div class="flex flex-col items-center justify-center h-full text-center">
                <div class="w-10 h-10 border-4 border-gray-200 border-t-[#2D5A27] rounded-full animate-spin mb-4"></div>
                <p class="text-gray-400 font-medium">Cargando experiencia XIGO...</p>
            </div>
        </div>

        <!-- Área de Error -->
        <div id="error-display" class="p-8 text-center hide">
            <div class="bg-red-50 p-6 rounded-2xl border border-red-100">
                <p class="text-red-600 font-bold mb-2">Error de Conexión</p>
                <p id="error-text" class="text-xs text-red-400 mb-4"></p>
                <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-2 rounded-xl text-xs font-bold uppercase tracking-widest">Reintentar</button>
            </div>
        </div>

        <!-- Botón de Siguiente -->
        <div id="footer-action" class="p-8 hide">
            <button id="next-btn" class="w-full bg-[#2D5A27] text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
                Siguiente
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN Y DATOS ---
        const ADMIN_PASSWORD = "XIGO2026";
        const surveyData = [
            { section: "Filtro", title: "¿En los últimos 30 días, has comprado comida preparada o empacada para consumir fuera de casa?", options: ["Sí, lo he comprado", "No, pero lo consideraría", "No, no me interesa"], type: "single", terminate: "No, no me interesa" },
            { section: "Filtro", title: "¿Cuál describe mejor tu situación actual?", options: ["Trabajo fuera de casa", "Trabajo desde casa / Online", "Trabajo mixto", "Estudiante / No trabajo"], type: "single" },
            { section: "Comida", title: "¿En qué situaciones elegirías comida lista durante un día laboral?", options: ["Poco tiempo", "Reuniones continuas", "No alcancé a cocinar", "Para comer en oficina", "Traslados", "Para llevar a casa"], type: "multiple" },
            { section: "Comida", title: "¿Qué tipo de comida te genera más confianza empacada? (Máx 3)", options: ["Tradicional ecuatoriana", "Casera ligera", "Bowls balanceados", "Ensaladas completas", "Sopas / Cremas", "Snacks salados"], type: "multiple", max: 3 },
            { section: "Precios", title: "¿Cuánto sueles pagar por tu almuerzo promedio entre semana?", options: ["Menos de $4.99", "$5.00 a $7.99", "$8.00 a $9.99", "$10.00 a $11.99", "$12.00 o más"], type: "single" },
            { section: "Bebidas", title: "¿Compras bebidas listas para tomar (agua, jugos, tés) en el trabajo?", options: ["Diario", "Varias veces/semana", "Ocasionalmente", "Rara vez", "Nunca"], type: "single" },
            { section: "Perfil", title: "¿En qué rango de edad te encuentras?", options: ["18-24", "25-34", "35-44", "45-54", "55+"], type: "single" }
        ];

        let currentIdx = 0;
        let answers = {};
        let selectedInStep = [];
        let db, auth, appId;
        let retryCount = 0;

        // --- REFERENCIAS ---
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const progressBar = document.getElementById('progress-bar');
        const footerAction = document.getElementById('footer-action');
        const nextBtn = document.getElementById('next-btn');
        const errorDisplay = document.getElementById('error-display');
        const errorText = document.getElementById('error-text');

        // --- LÓGICA DE INICIALIZACIÓN ---
        function startLoading() {
            appContainer.classList.add('visible');
            checkFirebaseReady();
        }

        function checkFirebaseReady() {
            if (typeof firebase !== 'undefined' && typeof __firebase_config !== 'undefined') {
                initApp();
            } else if (retryCount < 10) {
                retryCount++;
                setTimeout(checkFirebaseReady, 500);
            } else {
                showCriticalError("No se pudieron cargar las librerías necesarias. Revisa tu conexión.");
            }
        }

        async function initApp() {
            try {
                const config = JSON.parse(__firebase_config);
                firebase.initializeApp(config);
                
                db = firebase.firestore();
                auth = firebase.auth();
                appId = typeof __app_id !== 'undefined' ? __app_id : 'xigo-app';

                await auth.signInAnonymously();
                renderStep();
            } catch (err) {
                showCriticalError(err.message);
            }
        }

        function showCriticalError(msg) {
            mainContent.classList.add('hide');
            errorDisplay.classList.remove('hide');
            errorText.innerText = msg;
        }

        // --- NAVEGACIÓN ---
        function renderStep() {
            if (currentIdx >= surveyData.length) {
                renderEmailStep();
                return;
            }

            const q = surveyData[currentIdx];
            selectedInStep = [];
            footerAction.classList.add('hide');
            progressBar.style.width = `${((currentIdx + 1) / surveyData.length) * 100}%`;

            mainContent.innerHTML = `
                <div class="animate-in">
                    <p class="text-[#2D5A27] font-black text-[10px] uppercase tracking-widest mb-1 opacity-60">${q.section}</p>
                    <h2 class="text-xl font-black text-gray-800 leading-tight mb-6">${q.title}</h2>
                    <div class="space-y-3">
                        ${q.options.map(o => `
                            <button onclick="handleSelection('${o.replace(/'/g, "\\'")}')" class="option-btn w-full p-4 rounded-2xl text-left text-sm font-bold border-2 border-gray-100 text-gray-600 transition-all active:scale-[0.98]">
                                ${o}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        window.handleSelection = (val) => {
            const q = surveyData[currentIdx];
            
            if (q.type === 'single') {
                if (q.terminate && val === q.terminate) {
                    renderTerminated();
                    return;
                }
                answers[q.title] = val;
                
                // Efecto visual de selección
                const btns = document.querySelectorAll('.option-btn');
                btns.forEach(b => {
                    if (b.innerText.trim() === val) b.classList.add('selected');
                    else b.classList.remove('selected');
                });

                setTimeout(() => {
                    currentIdx++;
                    renderStep();
                }, 350);
            } else {
                const btn = Array.from(document.querySelectorAll('.option-btn')).find(b => b.innerText.trim() === val);
                if (selectedInStep.includes(val)) {
                    selectedInStep = selectedInStep.filter(i => i !== val);
                    btn.classList.remove('selected');
                } else {
                    if (q.max && selectedInStep.length >= q.max) return;
                    selectedInStep.push(val);
                    btn.classList.add('selected');
                }
                answers[q.title] = selectedInStep;
                
                if (selectedInStep.length > 0) footerAction.classList.remove('hide');
                else footerAction.classList.add('hide');
            }
        };

        nextBtn.onclick = () => {
            currentIdx++;
            renderStep();
        };

        function renderEmailStep() {
            progressBar.style.width = '100%';
            footerAction.classList.add('hide');
            mainContent.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center text-center">
                    <h2 class="text-2xl font-black mb-2 text-gray-800 uppercase tracking-tighter">¡LISTO!</h2>
                    <p class="text-xs text-gray-500 mb-8 font-medium">Déjanos tu email para enviarte el cupón de descuento.</p>
                    <input type="email" id="email-input" placeholder="tu@email.com" class="w-full p-4 border-2 rounded-2xl mb-4 text-center font-bold outline-none focus:border-[#2D5A27]" />
                    <button onclick="saveFinalData()" id="save-btn" class="w-full bg-[#2D5A27] text-white py-4 rounded-2xl font-black uppercase tracking-widest shadow-xl">FINALIZAR</button>
                </div>
            `;
        }

        window.saveFinalData = async () => {
            const email = document.getElementById('email-input').value;
            if (!email || !email.includes('@')) return;

            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerText = "ENVIANDO...";

            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').add({
                    email,
                    answers,
                    date: new Date().toISOString()
                });
                renderSuccess();
            } catch (e) {
                alert("Error al guardar: " + e.message);
                btn.disabled = false;
                btn.innerText = "FINALIZAR";
            }
        };

        function renderSuccess() {
            document.getElementById('progress-container').classList.add('hide');
            mainContent.innerHTML = `
                <div class="h-full flex flex-col justify-center items-center text-center p-6">
                    <div class="w-16 h-16 bg-green-50 text-[#2D5A27] rounded-full flex items-center justify-center mb-6 border-2 border-[#2D5A27] text-2xl">✓</div>
                    <h2 class="text-2xl font-black text-[#2D5A27] mb-2 uppercase">¡GRACIAS!</h2>
                    <p class="text-gray-500 text-sm">Tu cupón ha sido procesado.</p>
                </div>
            `;
        }

        function renderTerminated() {
            mainContent.innerHTML = `<div class="text-center p-8 mt-20"><p class="text-gray-400 italic">Gracias por tu interés, pero buscamos un perfil distinto para esta encuesta.</p></div>`;
        }

        // --- MODO ADMIN ---
        let adminClicks = 0;
        document.getElementById('admin-trigger').onclick = () => {
            adminClicks++;
            if (adminClicks >= 5) {
                if (prompt("Clave:") === ADMIN_PASSWORD) showAdminPanel();
                adminClicks = 0;
            }
        };

        async function showAdminPanel() {
            mainContent.innerHTML = `<p class="text-center py-20 text-xs uppercase tracking-widest text-gray-300">Consultando base de datos...</p>`;
            try {
                const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('responses').get();
                let html = `<h2 class="font-black text-xl mb-6">REPORTES (${snap.size})</h2>`;
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="bg-gray-50 p-4 rounded-xl mb-4 text-[10px]">
                        <p class="font-bold text-[#2D5A27]">${d.email}</p>
                        <p class="text-gray-400 mb-2">${d.date}</p>
                        <hr class="mb-2 opacity-10">
                        ${Object.entries(d.answers || {}).map(([q, a]) => `<b>${q}:</b> ${a}<br>`).join('')}
                    </div>`;
                });
                html += `<button onclick="location.reload()" class="w-full p-4 border rounded-xl text-xs font-bold text-gray-400">CERRAR</button>`;
                mainContent.innerHTML = html;
                document.getElementById('progress-container').classList.add('hide');
            } catch (e) { alert(e.message); }
        }

        // Inicio forzado al cargar ventana
        window.onload = startLoading;
    </script>
</body>
</html>
